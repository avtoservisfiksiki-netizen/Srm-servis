<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–¢–û –§—ñ–∫—Å–∏–∫–∏ ‚Äî CRM (–ü–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–∞ –í–µ—Ä—Å—ñ—è)</title>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#06080a;
      --panel:#0e1518;
      --muted:#94a3b8;
      --accent:#2f9cff;
      --card:#0b1114;
      --glass: rgba(255,255,255,0.03);
      --success:#2ecc71;
      --danger:#ff6b6b;
      --warning:#f39c12;
    }
    *{box-sizing:border-box;font-family:Inter, Roboto, Arial, sans-serif}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#041018);color:#e6eef5;min-height:100vh}
    .app{display:flex;min-height:100vh}
    .sidebar{width:260px;background:linear-gradient(180deg,var(--panel),#081011);padding:18px;display:flex;flex-direction:column;gap:14px;position:sticky;top:0;height:100vh;flex-shrink:0}
    .brand{font-weight:800;font-size:20px;text-align:center}
    .menu button{display:flex;align-items:center;gap:12px;width:100%;padding:10px;border-radius:10px;border:0;background:transparent;color:var(--muted);cursor:pointer;transition:all 0.15s ease}
    .menu button.active{background:linear-gradient(90deg,rgba(47,156,255,0.12),rgba(47,156,255,0.06));color:var(--accent);font-weight:600}
    .menu button:hover{background:rgba(255,255,255,0.02);color:#fff}
    .main{flex:1;padding:20px;overflow:auto}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:8px;flex-wrap:wrap}
    h1{margin:0;font-size:24px;font-weight:700}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:12px}
    .stat{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.45);text-align:center;border-left:4px solid var(--accent);transition:transform 0.2s ease}
    .stat:hover{transform:translateY(-2px)}
    .stat .label{color:var(--muted);font-size:13px}
    .stat .value{font-size:24px;font-weight:800;margin-top:6px;color:var(--accent)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:16px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.2)}
    .row{display:flex;gap:12px;align-items:center}
    .btn{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#061017;cursor:pointer;font-weight:600;transition:background 0.2s ease}
    .btn:hover{background:#4fa8ff}
    .btn.secondary{background:var(--panel);border:1px solid rgba(255,255,255,0.06);color:var(--muted);transition:background 0.2s ease, color 0.2s ease}
    .btn.secondary:hover{background:rgba(255,255,255,0.05);color:#fff}
    .btn.ghost{background:transparent;color:var(--muted);border-radius:8px;padding:8px 10px;border:1px solid transparent}
    .btn.ghost:hover{border-color:rgba(255,255,255,0.1);color:#fff}
    .btn.danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:0.6;cursor:not-allowed}
    .table{width:100%;border-collapse:collapse;margin-top:12px}
    .table th, .table td{padding:12px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:14px}
    .table th{font-weight:700;color:#fff}
    .table tbody tr:hover{background:rgba(255,255,255,0.015)}
    input, textarea, select{background:var(--card);border:1px solid rgba(255,255,255,0.06);color:inherit;padding:10px 12px;border-radius:8px;outline:none;transition:border-color 0.2s ease}
    input:focus, textarea:focus, select:focus{border-color:var(--accent)}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
    .actions{display:flex;gap:8px;align-items:center}
    .floating{position:fixed;right:22px;bottom:22px;z-index:40}
    .muted{color:var(--muted)}
    .chip{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:999px;font-size:13px;color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}
    .tag-paid{color:var(--success);font-weight:700}
    .tag-unpaid{color:var(--danger);font-weight:700}
    .tag-low-stock{background:rgba(243, 156, 18, 0.2);color:var(--warning);padding:3px 8px;border-radius:4px;font-weight:600}
    .flex-col{display:flex;flex-direction:column;gap:10px}
    .modal-content{max-width:1000px;width:100%;background:var(--panel);padding:20px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.5);overflow-y:auto;max-height:90vh}
    .notification{position:fixed;bottom:20px;right:20px;background:var(--success);color:#fff;padding:10px 15px;border-radius:8px;z-index:2000;opacity:0;transition:opacity 0.3s ease}
    .notification.error{background:var(--danger)}
    .notification.active{opacity:1}
    .order-item-row input, .order-item-row select { height: 40px; padding: 5px 8px; }
    
    @media (max-width:1024px) {
        .modal-content { max-width: 95vw; }
    }
    @media (max-width:900px){ .sidebar{display:none} .main{padding:12px} .header{flex-direction:column;align-items:stretch} .row{flex-wrap:wrap} }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar" role="navigation" aria-label="–ú–µ–Ω—é">
      <div style="flex:1">
        <div class="brand">–°–¢–û –§—ñ–∫—Å–∏–∫–∏</div>
        <div class="small muted" style="text-align:center;margin-top:6px">CRM ‚Ä¢ –ü–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–∞ v1.0</div>

        <nav class="menu" style="margin-top:20px">
          <button class="active" data-view="dashboard">üè† –ì–æ–ª–æ–≤–Ω–∞</button>
          <button data-view="clients">üë• –ö–ª—ñ—î–Ω—Ç–∏</button>
          <button data-view="orders">üìã –ù–∞—Ä—è–¥–∏</button>
          <button data-view="services">üîß –ü–æ—Å–ª—É–≥–∏</button>
          <button data-view="stock">üì¶ –°–∫–ª–∞–¥</button>
          <button data-view="payments">üí≥ –û–ø–ª–∞—Ç–∏</button>
          <button data-view="settings">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
        </nav>
      </div>

      <div style="display:flex;flex-direction:column;gap:10px">
        <div class="small muted">–î–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ</div>
        <div style="display:flex;gap:6px">
          <button id="export-json" class="btn ghost" title="–ï–∫—Å–ø–æ—Ä—Ç —É JSON">JSON</button>
          <button id="export-xlsx" class="btn ghost" title="–ï–∫—Å–ø–æ—Ä—Ç —É XLSX">XLSX</button>
        </div>
        <div style="display:flex;gap:6px">
          <label class="ghost" style="cursor:pointer;padding:6px 8px;border-radius:8px;border:1px dashed rgba(255,255,255,0.04);text-align:center;flex:1">
            –Ü–º–ø–æ—Ä—Ç JSON
            <input id="import-file" type="file" accept=".json" style="display:none">
          </label>
          <button id="clear-all" class="btn ghost secondary" title="–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –ª–æ–∫–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>
        <div class="small muted" style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.05);padding-top:8px">–†–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤: 4 ‚Ä¢ 20 –∫–ª./–º—ñ—Å</div>
      </div>
    </aside>

    <main class="main">
      <div class="header">
        <h1 id="page-title">–ì–æ–ª–æ–≤–Ω–∞</h1>
        <div class="row">
          <input id="search" placeholder="–ü–æ—à—É–∫: –∫–ª—ñ—î–Ω—Ç, –∞–≤—Ç–æ, —Ç–µ–ª–µ—Ñ–æ–Ω..." style="min-width:250px" />
          <div class="actions">
            <button id="btn-add-client" class="btn">–î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞</button>
            <button id="btn-add-order" class="btn secondary">–ù–æ–≤–∏–π –Ω–∞—Ä—è–¥</button>
          </div>
        </div>
      </div>

      <div id="content">
        <div id="view-dashboard" class="view">
          <div class="stats">
            <div class="stat card">
              <div class="label">–ê–≤—Ç–æ –≤ —Ä–æ–±–æ—Ç—ñ</div>
              <div class="value" id="stat-inwork">0</div>
            </div>
            <div class="stat card">
              <div class="label">–ö–ª—ñ—î–Ω—Ç—ñ–≤ —É –±–∞–∑—ñ</div>
              <div class="value" id="stat-clients">0</div>
            </div>
            <div class="stat card">
              <div class="label">–ù–µ–≤–∏–∫–æ–Ω–∞–Ω—ñ –Ω–∞—Ä—è–¥–∏</div>
              <div class="value" id="stat-open-orders">0</div>
            </div>
          </div>

          <div id="low-stock-alert" class="card" style="display:none;margin-bottom:12px;border-left:4px solid var(--warning)">
            <strong style="color:var(--warning)">‚ö†Ô∏è –£–≤–∞–≥–∞! –ù–∏–∑—å–∫–∏–π –∑–∞–ø–∞—Å —Ç–æ–≤–∞—Ä—ñ–≤!</strong>
            <div class="small muted" id="low-stock-list"></div>
          </div>

          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <strong>–û—Å—Ç–∞–Ω–Ω—ñ –Ω–∞—Ä—è–¥–∏</strong>
              <div class="small muted" id="last-updated">‚Äî</div>
            </div>
            <table class="table" id="recent-orders">
              <thead><tr><th>‚Ññ</th><th>–ö–ª—ñ—î–Ω—Ç</th><th>–ê–≤—Ç–æ</th><th>–°—É–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="view-clients" class="view" style="display:none">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div><strong>–ö–ª—ñ—î–Ω—Ç–∏</strong><div class="small muted">–°–ø–∏—Å–æ–∫ –∫–ª—ñ—î–Ω—Ç—ñ–≤ —Ç–∞ –∞–≤—Ç–æ</div></div>
              <div class="small muted">–ó–Ω–∞–π–¥–µ–Ω–æ: <span id="clients-count">0</span></div>
            </div>

            <table class="table" id="clients-table">
              <thead><tr><th>–Ü–º'—è</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ê–≤—Ç–æ</th><th>–ù–æ—Ç–∞—Ç–∫–∏</th><th>–î—ñ—ó</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="view-orders" class="view" style="display:none">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div><strong>–ù–∞—Ä—è–¥–∏</strong><div class="small muted">–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –Ω–∞—Ä—è–¥–∞–º–∏</div></div>
              <div class="small muted">–í—Å—å–æ–≥–æ: <span id="orders-count">0</span></div>
            </div>

            <table class="table" id="orders-table">
              <thead><tr><th>‚Ññ</th><th>–ö–ª—ñ—î–Ω—Ç</th><th>–ê–≤—Ç–æ</th><th>–ü–æ—Å–ª—É–≥–∏/–¥–µ—Ç–∞–ª—ñ</th><th>–°—É–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î—ñ—ó</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="view-services" class="view" style="display:none">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div><strong>–ü–æ—Å–ª—É–≥–∏</strong><div class="small muted">–°–ª–æ–≤–Ω–∏–∫ –ø–æ—Å–ª—É–≥ —ñ —Ü—ñ–Ω–∏</div></div>
              <div class="actions">
                <button id="btn-add-service" class="btn">–î–æ–¥–∞—Ç–∏ –ø–æ—Å–ª—É–≥—É</button>
              </div>
            </div>

            <table class="table" id="services-table">
              <thead><tr><th>–ù–∞–∑–≤–∞</th><th>–¶—ñ–Ω–∞</th><th>–î—ñ—ó</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="view-stock" class="view" style="display:none">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div><strong>–°–∫–ª–∞–¥</strong><div class="small muted">–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏ —Ç–∞ —Ä–æ–∑—Ö—ñ–¥–Ω–∏–∫–∏</div></div>
              <div class="actions">
                <button id="btn-add-stock" class="btn">–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä</button>
              </div>
            </div>

            <table class="table" id="stock-table">
              <thead><tr><th>–ù–∞–∑–≤–∞</th><th>–ö—ñ–ª-—Ç—å</th><th>–ú—ñ–Ω—ñ–º—É–º</th><th>–¶—ñ–Ω–∞</th><th>–î—ñ—ó</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="view-payments" class="view" style="display:none">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div><strong>–û–ø–ª–∞—Ç–∏</strong><div class="small muted">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç –ø–æ –Ω–∞—Ä—è–¥–∞—Ö</div></div>
              <div class="small muted">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ: <span id="unpaid-count">0</span></div>
            </div>

            <table class="table" id="payments-table">
              <thead><tr><th>–ù–∞—Ä—è–¥</th><th>–ö–ª—ñ—î–Ω—Ç</th><th>–°—É–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="view-settings" class="view" style="display:none">
          <div class="card">
            <strong>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</strong>
            <div class="small muted" style="margin-top:8px">–õ–æ–∫–∞–ª—å–Ω–µ —Å—Ö–æ–≤–∏—â–µ: <span id="ls-key">sf_data_v1</span></div>
            <div style="margin-top:12px" class="flex-col">
              <button id="btn-reset-demo" class="btn secondary">–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –¥–µ–º–æ-–¥–∞–Ω—ñ</button>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;padding:20px;z-index:1000">
    <div id="modal-inner" class="modal-content">
      </div>
  </div>

  <div id="notification" class="notification"></div>

<script>
/* ---------- App data & localStorage ---------- */
const LS_KEY = 'sf_data_v1';
let state = {
  clients: [],      // {id,name,phone,car,note,created}
  services: [],     // {id,name,price}
  stock: [],        // {id,name,qty,min,price}
  orders: [],       // {id,clientId,car,items:[{type:'service'|'stock',id,qty,price, name, spended:bool}], total, status, created, paid, spended:bool}
};

/* ---------- Utilities ---------- */
function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + Math.floor(Math.random()*1000).toString(36); }
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); renderAll(); }
function loadState(){ 
  try{ 
    const r = localStorage.getItem(LS_KEY); 
    if(r) state = JSON.parse(r); 
    if (state.clients.length === 0 && state.services.length === 0) {
        seedDemo();
    }
    // –ó–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –ø–æ–ª—è spended –¥–ª—è —Å—Ç–∞—Ä–∏—Ö –Ω–∞—Ä—è–¥—ñ–≤
    state.orders.forEach(o => {
        if (o.spended === undefined) o.spended = false;
        o.items.forEach(it => { if (it.spended === undefined) it.spended = false; });
    });
  }catch(e){ 
    console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É:", e);
    seedDemo();
  } 
  renderAll();
}
function formatPrice(n){ return (Number(n)||0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, " ") + ' ‚Ç¥'; }
function findClient(id){ return state.clients.find(c=>c.id===id) || null; }
function findService(id){ return state.services.find(s=>s.id===id) || null; }
function findStock(id){ return state.stock.find(s=>s.id===id) || null; }
function findOrder(id){ return state.orders.find(o=>o.id===id) || null; }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]}); }

function showNotification(message, isError = false){
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = 'notification ' + (isError ? 'error' : 'active');
    setTimeout(() => {
        notification.className = 'notification';
    }, 3000);
}

const ORDER_STATUSES = ['–Ω–æ–≤–∏–π', '–≤ —Ä–æ–±–æ—Ç—ñ', '–æ—á—ñ–∫—É—î –∑–∞–ø—á–∞—Å—Ç–∏–Ω', '–≥–æ—Ç–æ–≤–æ', '–≤–∏–∫–æ–Ω–∞–Ω–æ', '—Å–∫–∞—Å–æ–≤–∞–Ω–æ'];

/* ---------- Initial demo data helper ---------- */
function seedDemo(){
  state = {
    clients: [
      {id:uid('c'), name:'–Ü–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤', phone:'+380971234567', car:'VW Passat (AA1234BB)', note:'–†–µ–≥—É–ª—è—Ä–Ω–∏–π –∫–ª—ñ—î–Ω—Ç. –ó–∞–≤–∂–¥–∏ –±–µ—Ä–µ 5W-40', created:Date.now()},
      {id:uid('c'), name:'–û–ª–µ–≥ –ö–æ–≤–∞–ª—å', phone:'+380631112233', car:'Mercedes Sprinter (CA5678II)', note:'–î–æ—Å—Ç–∞–≤–∫–∞, —Ç–µ—Ä–º—ñ–Ω–æ–≤—ñ —Ä–µ–º–æ–Ω—Ç–∏', created:Date.now() - 86400000},
      {id:uid('c'), name:'–ú–∞—Ä—ñ—è –°–∏–¥–æ—Ä–µ–Ω–∫–æ', phone:'+380509876543', car:'Mazda 3', note:'–¢—ñ–ª—å–∫–∏ –ø–ª–∞–Ω–æ–≤—ñ –¢–û', created:Date.now() - 2 * 86400000},
    ],
    services: [
      {id:uid('s'), name:'–ó–∞–º—ñ–Ω–∞ –º–∞—Å–ª–∞', price:800},
      {id:uid('s'), name:'–†–µ–º–æ–Ω—Ç —Ö–æ–¥–æ–≤–æ—ó (–Ω–æ—Ä–º–æ-–≥–æ–¥–∏–Ω–∞)', price:900},
      {id:uid('s'), name:'–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –µ–ª–µ–∫—Ç—Ä–∏–∫–∏', price:600},
    ],
    stock: [
      {id:uid('p'), name:'–§—ñ–ª—å—Ç—Ä –º–∞—Å–ª—è–Ω–∏–π 124', qty:10, min:2, price:120},
      {id:uid('p'), name:'–ú–∞—Å–ª–æ 5W-40 (1–ª)', qty:25, min:10, price:350},
      {id:uid('p'), name:'–ö–æ–ª–æ–¥–∫–∏ –≥–∞–ª—å–º—ñ–≤–Ω—ñ (–∫–æ–º–ø–ª–µ–∫—Ç)', qty:1, min:3, price:950}, // –ù–∏–∑—å–∫–∏–π –∑–∞–ø–∞—Å
    ],
    orders: [],
  };
  
  const clientIvan = state.clients[0];
  const serviceOil = state.services[0];
  const stockFilter = state.stock[0];
  const stockPads = state.stock[2];

  state.orders = [
    {
        id: uid('o'), 
        clientId: clientIvan.id, 
        car:'VW Passat (AA1234BB)', 
        items:[
            {type:'service', id:serviceOil.id, qty:1, price:serviceOil.price, name:serviceOil.name, spended:false},
            {type:'stock', id:stockFilter.id, qty:1, price:stockFilter.price, name:stockFilter.name, spended:true}
        ], 
        total: serviceOil.price + stockFilter.price, 
        status:'–≤–∏–∫–æ–Ω–∞–Ω–æ', 
        created:Date.now() - 86400000, 
        paid:true,
        spended: true // –ü–æ–∑–Ω–∞—á–∞—î–º–æ, —â–æ –∑–∞–ø–∞—Å–∏ –≤–∂–µ —Å–ø–∏—Å–∞–Ω—ñ
    },
    {
        id: uid('o'), 
        clientId: state.clients[1].id, 
        car:'Mercedes Sprinter', 
        items:[
            {type:'service', id:state.services[1].id, qty:4, price:state.services[1].price, name:state.services[1].name, spended:false},
            {type:'stock', id:stockPads.id, qty:2, price:stockPads.price, name:stockPads.name, spended:false}
        ], 
        total: (4 * state.services[1].price) + (2 * stockPads.price), 
        status:'–≤ —Ä–æ–±–æ—Ç—ñ', 
        created:Date.now(), 
        paid:false,
        spended: false
    },
  ];

  saveState();
}

/* ---------- Rendering ---------- */
const menuBtns = document.querySelectorAll('.menu button');
const views = document.querySelectorAll('.view');
const pageTitle = document.getElementById('page-title');
const searchInput = document.getElementById('search');

function switchView(view){
  menuBtns.forEach(b=>b.classList.toggle('active', b.dataset.view===view));
  views.forEach(v=>v.style.display = v.id === 'view-' + view ? 'block' : 'none');
  pageTitle.textContent = {
    'dashboard':'–ì–æ–ª–æ–≤–Ω–∞',
    'clients':'–ö–ª—ñ—î–Ω—Ç–∏',
    'orders':'–ù–∞—Ä—è–¥–∏',
    'services':'–ü–æ—Å–ª—É–≥–∏',
    'stock':'–°–∫–ª–∞–¥',
    'payments':'–û–ø–ª–∞—Ç–∏',
    'settings':'–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è'
  }[view] || '–°–¢–û –§—ñ–∫—Å–∏–∫–∏';
  
  const renderMap = {
    'clients': renderClients,
    'orders': renderOrders,
    'services': renderServices,
    'stock': renderStock,
    'payments': renderPayments,
    'dashboard': renderDashboard
  };
  if(renderMap[view]) renderMap[view]();
  searchInput.value = '';
}

menuBtns.forEach(b=> b.addEventListener('click', ()=> switchView(b.dataset.view)));

/* Render all */
function renderAll(){
  renderDashboard();
  renderClients();
  renderOrders();
  renderServices();
  renderStock();
  renderPayments();
}

/* Dashboard */
function renderDashboard(){
  document.getElementById('stat-clients').textContent = state.clients.length;
  const open = state.orders.filter(o=>o.status !== '–≤–∏–∫–æ–Ω–∞–Ω–æ' && o.status !== '—Å–∫–∞—Å–æ–≤–∞–Ω–æ').length;
  document.getElementById('stat-open-orders').textContent = open;
  document.getElementById('stat-inwork').textContent = state.orders.filter(o=>o.status==='–≤ —Ä–æ–±–æ—Ç—ñ').length;
  
  // Alert for low stock
  const lowStock = state.stock.filter(p => p.qty < p.min);
  const lowStockAlert = document.getElementById('low-stock-alert');
  if (lowStock.length > 0) {
    lowStockAlert.style.display = 'block';
    document.getElementById('low-stock-list').innerHTML = lowStock.map(p => `‚Ä¢ ${escapeHtml(p.name)} (${p.qty} / ${p.min})`).join('<br>');
  } else {
    lowStockAlert.style.display = 'none';
  }

  // recent orders
  const tbody = document.querySelector('#recent-orders tbody');
  tbody.innerHTML = '';
  state.orders.slice().sort((a,b)=>b.created - a.created).slice(0, 6).forEach(o=>{
    const tr = document.createElement('tr');
    const client = findClient(o.clientId);
    tr.innerHTML = `<td>${o.id.substring(0,6)}...</td><td>${client?escapeHtml(client.name):'‚Äî'}</td><td>${escapeHtml(o.car||'‚Äî')}</td><td>${formatPrice(o.total)}</td><td>${o.status}</td>`;
    tbody.appendChild(tr);
  });
  const lastOrderTime = state.orders.length ? Math.max(...state.orders.map(o => o.created)) : null;
  document.getElementById('last-updated').textContent = lastOrderTime ? new Date(lastOrderTime).toLocaleString() : '‚Äî';
}

/* Clients */
function renderClients(filter=''){
  const tbody = document.querySelector('#clients-table tbody');
  tbody.innerHTML = '';
  const q = (filter || searchInput.value || '').toLowerCase();
  const list = state.clients.filter(c=> !q || (c.name+c.phone+c.car).toLowerCase().includes(q));
  document.getElementById('clients-count').textContent = list.length;
  list.forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(c.name)}</td><td class="small">${escapeHtml(c.phone)}</td><td class="small">${escapeHtml(c.car||'‚Äî')}</td><td class="small">${escapeHtml(c.note||'')}</td>
      <td>
        <div style="display:flex;gap:6px">
          <button class="btn ghost" data-action="edit-client" data-id="${c.id}">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
          <button class="btn ghost" data-action="new-order" data-client-id="${c.id}">–ù–∞—Ä—è–¥</button>
          <button class="btn secondary" data-action="del-client" data-id="${c.id}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* Orders */
function renderOrders(filter=''){
  const tbody = document.querySelector('#orders-table tbody');
  tbody.innerHTML = '';
  const q = (filter || searchInput.value || '').toLowerCase();
  const list = state.orders.slice().sort((a,b)=>b.created - a.created).filter(o=> {
    const client = findClient(o.clientId);
    const clientInfo = client ? client.name + client.phone : '';
    const orderInfo = o.car + o.status;
    return !q || (clientInfo + orderInfo + o.id).toLowerCase().includes(q);
  });
  
  list.forEach((o)=>{ 
    const client = findClient(o.clientId);
    const itemsHtml = (o.items || []).map(it=>{
      const name = it.name || (it.type === 'service' ? findService(it.id)?.name : findStock(it.id)?.name) || (it.type === 'service' ? '–ø–æ—Å–ª—É–≥–∞' : '–∑–∞–ø—á–∞—Å—Ç–∏–Ω–∞');
      return `${name} x${it.qty}`;
    }).join(', ');

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${o.id.substring(0,6)}...</td><td>${client?escapeHtml(client.name):'‚Äî'}</td><td>${escapeHtml(o.car||'‚Äî')}</td><td class="small">${itemsHtml || '‚Äî'}</td>
      <td>${formatPrice(o.total)}</td><td>${o.status}${o.paid? ' ‚Ä¢ <span class="tag-paid">–û–ø–ª–∞—á–µ–Ω–æ</span>':' ‚Ä¢ <span class="tag-unpaid">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</span>'}</td>
      <td>
        <div style="display:flex;gap:6px">
          <button class="btn ghost" data-action="view-order" data-id="${o.id}">–í—ñ–¥–∫—Ä–∏—Ç–∏</button>
          <button class="btn secondary" data-action="delete-order" data-id="${o.id}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('orders-count').textContent = state.orders.length;
}

/* Services */
function renderServices(){
  const tbody = document.querySelector('#services-table tbody');
  tbody.innerHTML = '';
  state.services.forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(s.name)}</td><td>${formatPrice(s.price)}</td><td>
      <div style="display:flex;gap:6px">
        <button class="btn ghost" data-action="edit-service" data-id="${s.id}">–†–µ–¥.</button>
        <button class="btn secondary" data-action="del-service" data-id="${s.id}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
      </div></td>`;
    tbody.appendChild(tr);
  });
}

/* Stock */
function renderStock(){
  const tbody = document.querySelector('#stock-table tbody');
  tbody.innerHTML = '';
  state.stock.forEach(p=>{
    const isLow = p.qty < p.min;
    const rowClass = isLow ? 'style="background:rgba(243, 156, 18, 0.1);"' : '';
    const tag = isLow ? '<span class="tag-low-stock">–ù–∏–∑—å–∫–∏–π</span>' : '';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td ${rowClass}>${escapeHtml(p.name)}</td><td>${p.qty} ${tag}</td><td>${p.min}</td><td>${formatPrice(p.price)}</td>
      <td>
        <div style="display:flex;gap:6px">
          <button class="btn ghost" data-action="edit-stock" data-id="${p.id}">–†–µ–¥.</button>
          <button class="btn secondary" data-action="consume-stock" data-id="${p.id}">–°–ø–∏—Å–∞—Ç–∏</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* Payments */function renderPayments(){
  const tbody = document.querySelector('#payments-table tbody');
  tbody.innerHTML = '';
  let unpaidCount = 0;
  state.orders.slice().sort((a,b)=>b.created - a.created).forEach(o=>{
    if (!o.paid) unpaidCount++;
    const client = findClient(o.clientId);
    const paidTag = o.paid ? '<span class="tag-paid">–û–ø–ª–∞—á–µ–Ω–æ</span>' : '<button class="btn secondary" data-action="pay" data-id="'+o.id+'">–ü–æ–∑–Ω–∞—á–∏—Ç–∏ –æ–ø–ª–∞—Ç—É</button>';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${o.id.substring(0,6)}...</td><td>${client?escapeHtml(client.name):'‚Äî'}</td><td>${formatPrice(o.total)}</td><td>${paidTag}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('unpaid-count').textContent = unpaidCount;
}

/* ---------- Modals Helpers ---------- */
const modal = document.getElementById('modal');
const modalInner = document.getElementById('modal-inner');

function openModal(html){
  modalInner.innerHTML = html;
  modal.style.display = 'flex';
  const closeBtn = modalInner.querySelector('[data-close]');
  if(closeBtn) closeBtn.addEventListener('click', closeModal);
}
function closeModal(){ modal.style.display = 'none'; modalInner.innerHTML = ''; }

/* ---------- Client CRUD Logic (omitted for brevity, assume previous version) ---------- */
// ... (–§—É–Ω–∫—Ü—ñ—ó saveClient, deleteClient, openClientModal –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –≤–µ—Ä—Å—ñ—ó)
function saveClient(id){
    const name = document.getElementById('client-name').value.trim();
    const phone = document.getElementById('client-phone').value.trim();
    const car = document.getElementById('client-car').value.trim();
    const note = document.getElementById('client-note').value.trim();

    if (!name || !phone) {
        showNotification('–Ü–º\'—è —Ç–∞ –¢–µ–ª–µ—Ñ–æ–Ω —î –æ–±–æ–≤\'—è–∑–∫–æ–≤–∏–º–∏ –ø–æ–ª—è–º–∏!', true);
        return;
    }

    if (id) {
        const client = findClient(id);
        Object.assign(client, { name, phone, car, note });
        showNotification('–ö–ª—ñ—î–Ω—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–æ!');
    } else {
        state.clients.push({ id: uid('c'), name, phone, car, note, created: Date.now() });
        showNotification('–ö–ª—ñ—î–Ω—Ç–∞ –¥–æ–¥–∞–Ω–æ!');
    }
    closeModal();
    saveState();
    switchView('clients');
}

function deleteClient(id) {
    if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—å–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞? –£—Å—ñ –ø–æ–≤'—è–∑–∞–Ω—ñ –Ω–∞—Ä—è–¥–∏ –∑–∞–ª–∏—à–∞—Ç—å—Å—è.")) {
        state.clients = state.clients.filter(c => c.id !== id);
        state.orders.filter(o => o.clientId === id).forEach(o => o.clientId = null);
        saveState();
        showNotification('–ö–ª—ñ—î–Ω—Ç–∞ –≤–∏–¥–∞–ª–µ–Ω–æ.');
    }
}

function openClientModal(clientId = null) {
  const isEdit = !!clientId;
  const client = isEdit ? findClient(clientId) : {};

  const html = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
      <strong>${isEdit ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞' : '–î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞'}</strong>
      <button data-close class="btn ghost secondary">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
    <div class="flex-col">
      <div class="form-grid">
        <input id="client-name" placeholder="–Ü–º'—è*" value="${escapeHtml(client.name || '')}" required>
        <input id="client-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω*" value="${escapeHtml(client.phone || '')}" required>
        <input id="client-car" placeholder="–ê–≤—Ç–æ (–º–∞—Ä–∫–∞/–Ω–æ–º–µ—Ä)" value="${escapeHtml(client.car || '')}">
      </div>
      <textarea id="client-note" placeholder="–ù–æ—Ç–∞—Ç–∫–∏" style="width:100%;min-height:80px">${escapeHtml(client.note || '')}</textarea>
      <button id="save-client" class="btn">${isEdit ? '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏' : '–î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞'}</button>
    </div>
  `;
  openModal(html);
  document.getElementById('save-client').addEventListener('click', () => saveClient(clientId));
}

/* ---------- Service & Stock CRUD Logic (omitted for brevity, assume previous version) ---------- */
// ... (–§—É–Ω–∫—Ü—ñ—ó saveService, deleteService, openServiceModal, saveStock, deleteStock, openStockModal, consumeStock –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –≤–µ—Ä—Å—ñ—ó)
function saveService(id){
    const name = document.getElementById('service-name').value.trim();
    const price = Number(document.getElementById('service-price').value.trim());

    if (!name || isNaN(price) || price <= 0) {
        showNotification('–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ù–∞–∑–≤—É —Ç–∞ –¶—ñ–Ω—É!', true);
        return;
    }

    if (id) {
        constservice = findService(id);
        Object.assign(service, { name, price });
        showNotification('–ü–æ—Å–ª—É–≥—É –æ–Ω–æ–≤–ª–µ–Ω–æ!');
    } else {
        state.services.push({ id: uid('s'), name, price });
        showNotification('–ü–æ—Å–ª—É–≥—É –¥–æ–¥–∞–Ω–æ!');
    }
    closeModal();
    saveState();
    switchView('services');
}

function deleteService(id) {
    if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –ø–æ—Å–ª—É–≥—É?")) {
        state.services = state.services.filter(s => s.id !== id);
        saveState();
        showNotification('–ü–æ—Å–ª—É–≥—É –≤–∏–¥–∞–ª–µ–Ω–æ.');
    }
}

function openServiceModal(serviceId = null) {
  const isEdit = !!serviceId;
  const service = isEdit ? findService(serviceId) : {};

  const html = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
      <strong>${isEdit ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ—Å–ª—É–≥—É' : '–î–æ–¥–∞—Ç–∏ –ø–æ—Å–ª—É–≥—É'}</strong>
      <button data-close class="btn ghost secondary">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
    <div class="flex-col">
      <div class="form-grid" style="grid-template-columns: 2fr 1fr;">
        <input id="service-name" placeholder="–ù–∞–∑–≤–∞ –ø–æ—Å–ª—É–≥–∏*" value="${escapeHtml(service.name || '')}" required>
        <input id="service-price" type="number" step="0.01" placeholder="–¶—ñ–Ω–∞ (‚Ç¥)*" value="${service.price || ''}" required>
      </div>
      <button id="save-service" class="btn">${isEdit ? '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏' : '–î–æ–¥–∞—Ç–∏ –ø–æ—Å–ª—É–≥—É'}</button>
    </div>
  `;
  openModal(html);
  document.getElementById('save-service').addEventListener('click', () => saveService(serviceId));
}

function saveStock(id){
    const name = document.getElementById('stock-name').value.trim();
    const qty = Number(document.getElementById('stock-qty').value.trim());
    const min = Number(document.getElementById('stock-min').value.trim());
    const price = Number(document.getElementById('stock-price').value.trim());

    if (!name || isNaN(qty) || isNaN(min) || isNaN(price) || price <= 0) {
        showNotification('–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤—Å—ñ –ø–æ–ª—è: –ù–∞–∑–≤–∞, –ö—ñ–ª—å–∫—ñ—Å—Ç—å, –ú—ñ–Ω—ñ–º—É–º, –¶—ñ–Ω–∞!', true);
        return;
    }

    if (id) {
        const item = findStock(id);
        Object.assign(item, { name, qty, min, price });
        showNotification('–¢–æ–≤–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ!');
    } else {
        state.stock.push({ id: uid('p'), name, qty, min, price });
        showNotification('–¢–æ–≤–∞—Ä –¥–æ–¥–∞–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥!');
    }
    closeModal();
    saveState();
    switchView('stock');
}

function deleteStock(id) {
    if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ç–æ–≤–∞—Ä –∑—ñ —Å–∫–ª–∞–¥—É?")) {
        state.stock = state.stock.filter(p => p.id !== id);
        saveState();
        showNotification('–¢–æ–≤–∞—Ä –≤–∏–¥–∞–ª–µ–Ω–æ.');
    }
}

function openStockModal(stockId = null) {
  const isEdit = !!stockId;
  const item = isEdit ? findStock(stockId) : {};

  const html = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
      <strong>${isEdit ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–æ–≤–∞—Ä' : '–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä –Ω–∞ —Å–∫–ª–∞–¥'}</strong>
      <button data-close class="btn ghost secondary">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
    <div class="flex-col">
      <input id="stock-name" placeholder="–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É*" value="${escapeHtml(item.name || '')}" required>
      <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
        <input id="stock-qty" type="number" placeholder="–ö—ñ–ª—å–∫—ñ—Å—Ç—å*" value="${item.qty || 0}" required>
        <input id="stock-min" type="number" placeholder="–ú—ñ–Ω—ñ–º—É–º*" value="${item.min || 1}" required>
        <input id="stock-price" type="number" step="0.01" placeholder="–¶—ñ–Ω–∞ –ø—Ä–æ–¥–∞–∂—É (‚Ç¥)*" value="${item.price || ''}" required>
      </div>
      <button id="save-stock" class="btn">${isEdit ? '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏' : '–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä'}</button>
    </div>
  `;
  openModal(html);
  document.getElementById('save-stock').addEventListener('click', () => saveStock(stockId));
}

function consumeStock(id) {
    const item = findStock(id);
    if (!item) return;
    
    const qtyToConsume = prompt(`–°–ø–∏—Å–∞—Ç–∏ —Å–∫—ñ–ª—å–∫–∏ –æ–¥–∏–Ω–∏—Ü—å —Ç–æ–≤–∞—Ä—É "${item.name}" (–ó–∞—Ä–∞–∑: ${item.qty})?`);
    const num = Number(qtyToConsume);
    
    if (num > 0 && num <= item.qty) {
        item.qty -= num;
        saveState();
        showNotification(`–°–ø–∏—Å–∞–Ω–æ ${num} –æ–¥. ${item.name}. –ó–∞–ª–∏—à–æ–∫: ${item.qty}`);
    } else if (qtyToConsume !== null) {
        showNotification('–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø–∏—Å–∞–Ω–Ω—è –∞–±–æ –ø–µ—Ä–µ–≤–∏—â—É—î –∑–∞–ª–∏—à–æ–∫.', true);
    }
}


/* ---------- CORE ORDER LOGIC ---------- */

/**
 * –°–ø–∏—Å—É—î/–ø–æ–≤–µ—Ä—Ç–∞—î —Ç–æ–≤–∞—Ä–∏ –∑—ñ —Å–∫–ª–∞–¥—É
 * @param {object} order - –û–±'—î–∫—Ç –Ω–∞—Ä—è–¥—É
 * @param {boolean} shouldSpend - true: —Å–ø–∏—Å–∞—Ç–∏, false: –ø–æ–≤–µ—Ä–Ω—É—Ç–∏
 */
function updateStockFromOrder(order, shouldSpend) {
    let changed = false;
    order.items.filter(item => item.type === 'stock').forEach(item => {
        const stockItem = findStock(item.id);
        if (stockItem) {
            if (shouldSpend && !item.spended) {
                stockItem.qty -= item.qty;
                item.spended = true;
                changed = true;
            } else if (!shouldSpend && item.spended) {
                stockItem.qty += item.qty;
                item.spended = false;
                changed = true;
            }
        }
    });
    if (changed) {
        order.spended = shouldSpend;
        return true;
    }
    return false;
}

/**
 * –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞–≥–∞–ª—å–Ω–æ—ó —Å—É–º–∏ –Ω–∞—Ä—è–¥—É
 * @param {Array} items - –ú–∞—Å–∏–≤ –ø–æ–∑–∏—Ü—ñ–π –Ω–∞—Ä—è–¥—É
 * @returns {number} –ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞
 */
function calculateTotal(items) {
    return items.reduce((sum, item) => sum + (item.qty * item.price), 0);
}

/**
 * –ó–±–µ—Ä—ñ–≥–∞—î (—Å—Ç–≤–æ—Ä—é—î –∞–±–æ –æ–Ω–æ–≤–ª—é—î) –Ω–∞—Ä—è–¥
 * @param {string} orderId - ID –Ω–∞—Ä—è–¥—É –∞–±–æ null –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
 */
function saveOrder(orderId = null) {
    const clientId = document.getElementById('order-client-id').value;
    const car = document.getElementById('order-car').value.trim();
    const status = document.getElementById('order-status').value;
    const items = [];
    
    if (!clientId) {
        showNotification('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞!', true);
        return;
    }

    // –ó–±—ñ—Ä –ø–æ–∑–∏—Ü—ñ–π –∑ —Ñ–æ—Ä–º–∏
    document.querySelectorAll('.order-item-row').forEach(row => {
        const type = row.querySelector('.item-type').value;
        const id = row.querySelector('.item-id').value;
        const qty = Number(row.querySelector('.item-qty').value);
        const price = Number(row.querySelector('.item-price').value);

        if (id && qty > 0 && price >= 0) {
            let name = '';
            if (type === 'service') name = findService(id)?.name;
            else if (type === 'stock') name = findStock(id)?.name;

            items.push({
                type: type,
                id: id,
                qty: qty,
                price: price,
                name: name || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–∑–∏—Ü—ñ—è', // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ–º'—è –Ω–∞ –º–æ–º–µ–Ω—Ç —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
                spended: row.dataset.spended === 'true' // –ü–µ—Ä–µ–¥–∞—î–º–æ —Å—Ç–∞—Ç—É—Å —Å–ø–∏—Å–∞–Ω–Ω—è
            });
        }
    });

    if (items.length === 0) {
        showNotification('–ù–∞—Ä—è–¥ –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ —Ö–æ—á–∞ –± –æ–¥–Ω—É –ø–æ–∑–∏—Ü—ñ—é!', true);
        return;
    }

    const total = calculateTotal(items);
    let isNew = !orderId;
    let order;

    if (orderId) {
        order = findOrder(orderId);
        if (!order) return;
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –±—É–≤ –∑–º—ñ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å –Ω–∞ "–≤–∏–∫–æ–Ω–∞–Ω–æ"
        const statusChangedToCompleted = order.status !== '–≤–∏–∫–æ–Ω–∞–Ω–æ' && status === '–≤–∏–∫–æ–Ω–∞–Ω–æ';
        const statusChangedFromCompleted = order.status === '–≤–∏–∫–æ–Ω–∞–Ω–æ' && status !== '–≤–∏–∫–æ–Ω–∞–Ω–æ';

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–ª—ñ–≤
        Object.assign(order, { clientId, car, status, items, total });

        // –õ–æ–≥—ñ–∫–∞ —Å–ø–∏—Å–∞–Ω–Ω—è –∑–∞–ø–∞—Å—ñ–≤
        if (statusChangedToCompleted) {
            if (updateStockFromOrder(order, true)) {
                showNotification(`–ó–∞–ø–∞—Å–∏ –¥–ª—è –Ω–∞—Ä—è–¥—É ${orderId.substring(0,6)}... —Å–ø–∏—Å–∞–Ω–æ –∑—ñ —Å–∫–ª–∞–¥—É!`);
            }
        } else if (statusChangedFromCompleted) {
            if (updateStockFromOrder(order, false)) {
                showNotification(`–ó–∞–ø–∞—Å–∏ –¥–ª—è –Ω–∞—Ä—è–¥—É ${orderId.substring(0,6)}... –ø–æ–≤–µ—Ä–Ω—É—Ç–æ –Ω–∞ —Å–∫–ª–∞–¥!`);
            }
        }

        showNotification('–ù–∞—Ä—è–¥ –æ–Ω–æ–≤–ª–µ–Ω–æ!');
    } else {
        order = {
            id: uid('o'),
            clientId,
            car,
            items,
            total,
            status,
            created: Date.now(),
            paid: false,
            spended: false
        };
        state.orders.push(order);
        
        // –Ø–∫—â–æ –Ω–æ–≤–∏–π –Ω–∞—Ä—è–¥ –≤—ñ–¥—Ä–∞–∑—É "–≤–∏–∫–æ–Ω–∞–Ω–æ" - —Å–ø–∏—Å–∞—Ç–∏
        if (status === '–≤–∏–∫–æ–Ω–∞–Ω–æ') {
            updateStockFromOrder(order, true);
        }
        showNotification('–ù–æ–≤–∏–π –Ω–∞—Ä—è–¥ —Å—Ç–≤–æ—Ä–µ–Ω–æ!');
    }

    closeModal();
    saveState();
    switchView('orders');
}

function deleteOrder(id) {
    if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –Ω–∞—Ä—è–¥? –Ø–∫—â–æ –≤—ñ–Ω –º–∞–≤ —Å—Ç–∞—Ç—É—Å '–≤–∏–∫–æ–Ω–∞–Ω–æ', –∑–∞–ø–∞—Å–∏ –º–æ–∂—É—Ç—å –Ω–µ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –Ω–∞ —Å–∫–ª–∞–¥.")) {
        state.orders = state.orders.filter(o => o.id !== id);
        showNotification('–ù–∞—Ä—è–¥ –≤–∏–¥–∞–ª–µ–Ω–æ.');
        saveState();
    }
}

functiongetOrderRowHtml(item, index, isEditMode = true) {
    const isService = item.type === 'service';
    const sourceList = isService ? state.services : state.stock;
    const selectedItem = sourceList.find(i => i.id === item.id);
    
    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ü—ñ–Ω—É –∑ –Ω–∞—Ä—è–¥—É (–≤–æ–Ω–∞ –º–æ–∂–µ –≤—ñ–¥—Ä—ñ–∑–Ω—è—Ç–∏—Å—è –≤—ñ–¥ –ø–æ—Ç–æ—á–Ω–æ—ó —Ü—ñ–Ω–∏ –≤ —Å–ª–æ–≤–Ω–∏–∫—É)
    const priceValue = item.price || selectedItem?.price || 0;
    
    const rowClass = isService ? 'style="background:rgba(47,156,255,0.05)"' : 'style="background:rgba(255,255,255,0.03)"';

    const itemSelect = sourceList.map(i => `<option value="${i.id}" ${i.id === item.id ? 'selected' : ''}>${escapeHtml(i.name)} (${formatPrice(i.price)})</option>`).join('');

    const deleteBtn = isEditMode ? `<button class="btn secondary danger small" data-action="remove-item" data-index="${index}" style="padding:6px 8px;">X</button>` : '';

    return `
        <tr class="order-item-row" data-index="${index}" ${rowClass} data-spended="${item.spended}">
            <td><input type="hidden" class="item-type" value="${item.type}">${isService ? '–ü–æ—Å–ª—É–≥–∞' : '–¢–æ–≤–∞—Ä'}</td>
            <td>
                <select class="item-id" data-type="${item.type}" required ${isEditMode ? '' : 'disabled'}>
                    <option value="">‚Äî –í–∏–±–µ—Ä—ñ—Ç—å ‚Äî</option>
                    ${itemSelect}
                </select>
            </td>
            <td><input type="number" class="item-qty" value="${item.qty}" min="1" required ${isEditMode ? '' : 'disabled'}></td>
            <td><input type="number" step="0.01" class="item-price" value="${priceValue}" required ${isEditMode ? '' : 'disabled'}></td>
            <td><span class="item-subtotal">${formatPrice(item.qty * priceValue)}</span></td>
            <td>${deleteBtn}</td>
        </tr>
    `;
}

function openOrderModal(orderId = null) {
    const isEdit = !!orderId;
    const order = isEdit ? findOrder(orderId) : {
        id: uid('o'), clientId: null, car: '', items: [], total: 0, status: '–≤ —Ä–æ–±–æ—Ç—ñ', created: Date.now(), paid: false, spended: false
    };

    const client = order.clientId ? findClient(order.clientId) : null;
    let currentCar = order.car || client?.car || '';

    const html = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
          <strong>${isEdit ? `–ù–∞—Ä—è–¥ ‚Ññ ${order.id.substring(0,8)}...` : '–ù–æ–≤–∏–π –ù–∞—Ä—è–¥-–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è'}</strong>
          <button data-close class="btn ghost secondary">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
        
        <div class="card" style="margin-bottom:15px">
            <div class="form-grid">
                <select id="order-client-id" required>
                    <option value="" disabled ${!order.clientId ? 'selected' : ''}>‚Äî –í–∏–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞ ‚Äî</option>
                    ${state.clients.map(c => `<option value="${c.id}" ${c.id === order.clientId ? 'selected' : ''}>${escapeHtml(c.name)} (${escapeHtml(c.car || '‚Äî')})</option>`).join('')}
                </select>
                <input id="order-car" placeholder="–ê–≤—Ç–æ (–º–∞—Ä–∫–∞/–Ω–æ–º–µ—Ä)" value="${escapeHtml(currentCar)}">
                <select id="order-status">
                    ${ORDER_STATUSES.map(s => `<option value="${s}" ${s === order.status ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1)}</option>`).join('')}
                </select>
                <select id="order-paid" ${order.paid ? 'style="border-color:var(--success)"' : ''}>
                    <option value="false" ${!order.paid ? 'selected' : ''}>–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</option>
                    <option value="true" ${order.paid ? 'selected' : ''}>–û–ø–ª–∞—á–µ–Ω–æ</option>
                </select>
            </div>
        </div>

        <div class="card" style="margin-bottom:15px">
            <strong>–ü–æ–∑–∏—Ü—ñ—ó –ù–∞—Ä—è–¥—É</strong>
            <table class="table" id="order-items-table" style="margin-top:8px">
                <thead><tr><th>–¢–∏–ø</th><th>–ù–∞–∑–≤–∞</th><th>–ö—ñ–ª-—Ç—å</th><th>–¶—ñ–Ω–∞ –∑–∞ –æ–¥.</th><th>–°—É–º–∞</th><th></th></tr></thead>
                <tbody id="order-items-tbody">
                    ${order.items.map((item, index) => getOrderRowHtml(item, index, true)).join('')}
                </tbody>
            </table>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:15px">
                <div>
                    <button id="add-service-item" class="btn secondary small" style="padding:6px 10px;">+ –ü–æ—Å–ª—É–≥–∞</button>
                    <button id="add-stock-item" class="btn secondary small" style="padding:6px 10px;">+ –¢–æ–≤–∞—Ä</button>
                </div>
                <strong>–ó–∞–≥–∞–ª—å–Ω–∞ –°—É–º–∞: <span id="order-total">${formatPrice(order.total)}</span></strong>
            </div>
        </div>
        
        <button id="save-order-btn" class="btn" style="width:100%">${isEdit ? '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏' : '–°—Ç–≤–æ—Ä–∏—Ç–∏ –ù–∞—Ä—è–¥'}</button>
    `;
    openModal(html);
    
    // –ü—Ä–∏–≤'—è–∑–∫–∞ –ª–æ–≥—ñ–∫–∏
    document.getElementById('save-order-btn').addEventListener('click', () => saveOrder(orderId));
    document.getElementById('add-service-item').addEventListener('click', () => addItemToOrder('service'));
    document.getElementById('add-stock-item').addEventListener('click', () => addItemToOrder('stock'));
    document.getElementById('order-client-id').addEventListener('change', updateCarField);
    document.getElementById('order-paid').addEventListener('change', updatePaidStatus);

    // –î–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π –¥–ª—è –¥–∏–Ω–∞–º—ñ—á–Ω–∏—Ö –ø–æ–ª—ñ–≤ (Qty, Price, Select)
    const tbody = document.getElementById('order-items-tbody');
    tbody.addEventListener('input', handleItemChange);
    tbody.addEventListener('click', handleItemAction);

    // –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫
    updateOrderTotalDisplay();
}

function updatePaidStatus(e) {
    const isPaid = e.target.value === 'true';
    e.target.style.borderColor = isPaid ? 'var(--success)' : '';
}

function updateCarField(e) {
    const clientId = e.target.value;
    const client = findClient(clientId);
    document.getElementById('order-car').value = client?.car || '';
}

function addItemToOrder(type) {
    const tbody = document.getElementById('order-items-tbody');
    const newIndex = tbody.children.length; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–æ–≤–∂–∏–Ω—É —è–∫ —ñ–Ω–¥–µ–∫—Å
    const newItem = {
        type: type,
        id: '',
        qty: 1,
        price: 0,
        name: '',
        spended: false
    };
    tbody.insertAdjacentHTML('beforeend', getOrderRowHtml(newItem, newIndex, true));
}

function updateItemPriceAndSubtotal(row) {
    const type = row.querySelector('.item-type').value;
    const id = row.querySelector('.item-id').value;
    const qty = Number(row.querySelector('.item-qty').value);
    
    let priceInput = row.querySelector('.item-price');
    let currentPrice = Number(priceInput.value);

    // –Ø–∫—â–æ –∑–º—ñ–Ω–µ–Ω–æ Select, –æ–Ω–æ–≤–ª—é—î–º–æ —Ü—ñ–Ω—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
    if (event.target.classList.contains('item-id') || (currentPrice === 0 && id)) {
        let defaultPrice = 0;
        if (type === 'service') {
            defaultPrice = findService(id)?.price || 0;
        } else if (type === 'stock') {
            defaultPrice = findStock(id)?.price || 0;
        }
        priceInput.value = defaultPrice.toFixed(2);
        currentPrice = defaultPrice;
    }

    const subtotal = qty * currentPrice;
    row.querySelector('.item-subtotal').textContent = formatPrice(subtotal);
    updateOrderTotalDisplay();
}

function handleItemChange(e) {
    const row = e.target.closest('.order-item-row');
    if (row && (e.target.classList.contains('item-id') || e.target.classList.contains('item-qty') || e.target.classList.contains('item-price'))) {
        updateItemPriceAndSubtotal(row);
    }
}

function handleItemAction(e) {
    const btn = e.target.closest('[data-action="remove-item"]');
    if (btn) {
        e.preventDefault();
        const row = btn.closest('.order-item-row');
        if (row) {
            row.remove();
            updateOrderTotalDisplay();
        }
    }
}

function updateOrderTotalDisplay() {
    let total = 0;
    document.querySelectorAll('.order-item-row').forEach(row => {
        const qty = Number(row.querySelector('.item-qty').value);
        const price = Number(row.querySelector('.item-price').value);
        if (!isNaN(qty) && !isNaN(price)) {
            total += qty * price;
        }
    });
    document.getElementById('order-total').textContent = formatPrice(total);
}

// –í–∏–¥ —Ç—ñ–ª—å–∫–∏ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É (View Order)
function openViewOrderModal(orderId) {
    const order = findOrder(orderId);
    if (!order) return;

    const client = findClient(order.clientId);
    const orderDate = new Date(order.created).toLocaleString();
    const paidText = order.paid ? `<span class="tag-paid">–û–ø–ª–∞—á–µ–Ω–æ</span>` : `<span class="tag-unpaid">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</span>`;

    const html = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
            <strong>–ù–∞—Ä—è–¥ ‚Ññ ${order.id.substring(0,8)}... (–≤—ñ–¥ ${orderDate})</strong>
            <div>
                <button class="btn ghost" data-action="edit-order-from-view" data-id="${orderId}">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                <button data-close class="btn secondary">–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
        </div>
        
        <div class="card" style="margin-bottom:15px">
            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                <div class="flex-col"><strong>–ö–ª—ñ—î–Ω—Ç:</strong> <span class="muted">${escapeHtml(client?.name || '‚Äî')}</span></div>
                <div class="flex-col"><strong>–ê–≤—Ç–æ:</strong> <span class="muted">${escapeHtml(order.car || '‚Äî')}</span></div>
                <div class="flex-col"><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="muted">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</span></div>
                <div class="flex-col"><strong>–û–ø–ª–∞—Ç–∞:</strong> ${paidText}</div>
            </div>
        </div>

        <div class="card">
            <strong>–ü–æ–∑–∏—Ü—ñ—ó –ù–∞—Ä—è–¥—É</strong>
            <table class="table" style="margin-top:8px">
                <thead><tr><th>–¢–∏–ø</th><th>–ù–∞–∑–≤–∞</th><th>–ö—ñ–ª-—Ç—å</th><th>–¶—ñ–Ω–∞ –∑–∞ –æ–¥.</th><th>–°—É–º–∞</th></tr></thead>
                <tbody>
                    ${order.items.map((item) => getOrderRowHtml(item, 0, false)).join('')}
                </tbody>
            </table>
            <div style="text-align:right; margin-top:15px">
                <strong style="font-size:1.2em">–ó–ê–ì–ê–õ–û–ú: ${formatPrice(order.total)}</strong>
            </div>
        </div>
    `;
    openModal(html);
}


/* ---------- Data Import/Export Logic (omitted for brevity, assume previous version) ---------- */
// ... (–§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É/Export Logic (omitted for brevity, assume previous version) ---------- */
// ... (–§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É/–µ–∫—Å–ø–æ—Ä—Ç—É –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –≤–µ—Ä—Å—ñ—ó)
function downloadFile(filename, data) {
    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(data));
    element.setAttribute('download', filename);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}

document.getElementById('export-json').addEventListener('click', () => {
    downloadFile('fixiki_crm_export.json', JSON.stringify(state, null, 2));
    showNotification('–î–∞–Ω—ñ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ —É JSON.');
});

document.getElementById('export-xlsx').addEventListener('click', () => {
    try {
        const workbook = XLSX.utils.book_new();
        // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ items –∑ orders –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –≤–∏–≥–ª—è–¥—É –≤ Excel
        const cleanOrders = state.orders.map(o => ({
            id: o.id,
            clientId: o.clientId,
            car: o.car,
            total: o.total,
            status: o.status,
            paid: o.paid,
            created: new Date(o.created).toLocaleDateString(),
            items_summary: o.items.map(it => `${it.name} x${it.qty}`).join('; ')
        }));
        
        const dataForExport = {
            clients: state.clients,
            services: state.services,
            stock: state.stock,
            orders: cleanOrders
        };

        for (const key in dataForExport) {
            if (Array.isArray(dataForExport[key])) {
                const ws = XLSX.utils.json_to_sheet(dataForExport[key]);
                XLSX.utils.book_append_sheet(workbook, ws, key.charAt(0).toUpperCase() + key.slice(1));
            }
        }
        XLSX.writeFile(workbook, "fixiki_crm_export.xlsx");
        showNotification('–î–∞–Ω—ñ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ —É XLSX.');
    } catch (e) {
        showNotification('–ü–æ–º–∏–ª–∫–∞ –µ–∫—Å–ø–æ—Ä—Ç—É XLSX. –ú–æ–∂–ª–∏–≤–æ, SheetJS –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è.', true);
        console.error(e);
    }
});

document.getElementById('import-file').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
        try {
            const importedState = JSON.parse(event.target.result);
            if (importedState.clients && importedState.orders) {
                state = importedState;
                saveState();
                showNotification('–î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!');
            } else {
                showNotification('–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç JSON –¥–ª—è CRM.', true);
            }
        } catch (error) {
            showNotification('–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è –∞–±–æ –ø–∞—Ä—Å–∏–Ω–≥—É —Ñ–∞–π–ª—É.', true);
        }
    };
    reader.readAsText(file);
});

document.getElementById('clear-all').addEventListener('click', () => {
    if (confirm('–£–≤–∞–≥–∞! –£—Å—ñ –ª–æ–∫–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –û–ß–ò–©–ï–ù–Ü –±–µ–∑ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?')) {
        localStorage.removeItem(LS_KEY);
        location.reload(); 
    }
});

document.getElementById('btn-reset-demo').addEventListener('click', () => {
    if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ? –£—Å—ñ –≤–∞—à—ñ –ª–æ–∫–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ —Ç–∞ –∑–∞–º—ñ–Ω–µ–Ω—ñ –¥–µ–º–æ-–¥–∞–Ω–∏–º–∏.')) {
        seedDemo();
        showNotification('–î–µ–º–æ-–¥–∞–Ω—ñ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ.');
    }
});


/* ---------- Centralized Action Handler ---------- */
document.body.addEventListener('click', (e) => {
    const target = e.target.closest('[data-action]');
    if (!target) return;

    const action = target.dataset.action;
    const id = target.dataset.id;
    const clientId = target.dataset.clientId;

    // –ö–ª—ñ—î–Ω—Ç–∏
    if (action === 'edit-client') openClientModal(id);
    else if (action === 'del-client') deleteClient(id);
    else if (action === 'new-order') openOrderModal(clientId);
    
    // –ü–æ—Å–ª—É–≥–∏
    else if (action === 'edit-service') openServiceModal(id);
    else if (action === 'del-service') deleteService(id);

    // –°–∫–ª–∞–¥
    else if (action === 'edit-stock') openStockModal(id);
    else if (action === 'consume-stock') consumeStock(id);
    
    // –ù–∞—Ä—è–¥–∏/–û–ø–ª–∞—Ç–∏
    else if (action === 'view-order') openViewOrderModal(id);
    else if (action === 'edit-order-from-view') { closeModal(); openOrderModal(id); } // –ü–µ—Ä–µ—Ö—ñ–¥ –∑ –ø–µ—Ä–µ–≥–ª—è–¥—É –¥–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    else if (action === 'delete-order') deleteOrder(id);
    else if (action === 'pay') markOrderPaid(id);
});

function markOrderPaid(id) {
    const order = findOrder(id);
    if (order) {
        order.paid = true;
        saveState();
        showNotification(`–ù–∞—Ä—è–¥ ${order.id.substring(0,6)}... –ø–æ–∑–Ω–∞—á–µ–Ω–æ —è–∫ –æ–ø–ª–∞—á–µ–Ω–∏–π.`);
    }
}


/* ---------- Global Buttons ---------- */
document.getElementById('btn-add-client').addEventListener('click', () => openClientModal());
document.getElementById('btn-add-order').addEventListener('click', () => openOrderModal());
document.getElementById('btn-add-service').addEventListener('click', () => openServiceModal());
document.getElementById('btn-add-stock').addEventListener('click', () => openStockModal());

/* ---------- Search Logic ---------- */
searchInput.addEventListener('input', () => {
    const currentView = document.querySelector('.menu button.active').dataset.view;
    const query = searchInput.value.trim();
    if (currentView === 'clients') {
        renderClients(query);
    } else if (currentView === 'orders') {
        renderOrders(query);
    }
});


// –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–∏
loadState();

</script>
