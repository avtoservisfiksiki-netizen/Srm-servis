<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–°–¢–û –§—ñ–∫—Å–∏–∫–∏ ‚Äî CRM PWA v3.1</title>
<meta name="theme-color" content="#0e1518">
<link rel="manifest" href="manifest.json">
<style>
:root{--bg:#06080a;--panel:#0e1518;--muted:#94a3b8;--accent:#2f9cff;--card:#0b1114;--success:#2ecc71;--danger:#ff6b6b}
*{box-sizing:border-box;font-family:Inter, Roboto, Arial, sans-serif}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,var(--bg),#041018);color:#e6eef5;min-height:100vh}
.app{display:flex;min-height:100vh}
.sidebar{width:260px;background:linear-gradient(180deg,var(--panel),#081011);padding:18px;display:flex;flex-direction:column;gap:14px;flex-shrink:0}
.brand{font-weight:800;font-size:20px;text-align:center}
.menu button{display:flex;align-items:center;gap:12px;width:100%;padding:10px;border-radius:10px;border:0;background:transparent;color:var(--muted);cursor:pointer}
.menu button.active{background:linear-gradient(90deg,rgba(47,156,255,0.12),rgba(47,156,255,0.06));color:var(--accent);font-weight:600}
.main{flex:1;padding:16px;overflow:auto;height:100vh}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:8px;flex-wrap:wrap}
h1{margin:0;font-size:20px;font-weight:700}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:14px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.2)}
.table{width:100%;border-collapse:collapse;margin-top:12px}
.table th, .table td{padding:10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:14px}
input,textarea,select{background:var(--card);border:1px solid rgba(255,255,255,0.06);color:inherit;padding:8px;border-radius:8px}
.btn{padding:8px 12px;border-radius:10px;border:0;background:var(--accent);color:#061017;cursor:pointer;font-weight:600}
.btn.secondary{background:var(--panel);border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
.small{font-size:13px;color:var(--muted)}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;padding:20px;z-index:1200}
.modal.active{display:flex}
.modal-content{max-width:1000px;width:100%;background:var(--panel);padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6);overflow:auto;max-height:90vh}
.notification{position:fixed;bottom:20px;right:20px;background:var(--success);color:#fff;padding:10px 15px;border-radius:8px;z-index:2000;opacity:0;transition:opacity .3s}
.notification.active{opacity:1}
.user-badge{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-weight:700}
.hidden{display:none}
.assign-list{max-height:160px;overflow:auto;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px}
</style>
</head>
<body>
<div id="app" class="app" style="display:none">
  <aside class="sidebar">
    <div style="display:flex;flex-direction:column;gap:8px">
      <div class="brand">–°–¢–û –§—ñ–∫—Å–∏–∫–∏</div>
      <div class="small">CRM PWA ‚Ä¢ v3.1</div>
      <div id="user-info" style="margin-top:8px"></div>
    </div>
    <nav class="menu" style="margin-top:12px">
      <button class="active" data-view="dashboard">üè† –ì–æ–ª–æ–≤–Ω–∞</button>
      <button data-view="clients">üë• –ö–ª—ñ—î–Ω—Ç–∏</button>
      <button data-view="orders">üìã –ù–∞—Ä—è–¥–∏</button>
      <button data-view="stock">üì¶ –°–∫–ª–∞–¥</button>
      <button data-view="services">‚öôÔ∏è –ü–æ—Å–ª—É–≥–∏</button>
      <button data-view="users" id="users-tab">üë®‚Äçüîß –ö–µ—Ä—É–≤–∞–Ω–Ω—è –º–∞–π—Å—Ç—Ä–∞–º–∏</button>
      <button data-view="settings">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
    </nav>

    <div style="margin-top:auto;display:flex;flex-direction:column;gap:8px">
      <button id="export-json" class="btn secondary">–ï–∫—Å–ø–æ—Ä—Ç JSON</button>
      <button id="export-xlsx" class="btn secondary">–ï–∫—Å–ø–æ—Ä—Ç XLSX</button>
      <label style="display:block;text-align:center;border:1px dashed rgba(255,255,255,0.04);padding:8px;border-radius:8px;cursor:pointer" title="–Ü–º–ø–æ—Ä—Ç JSON">
        –Ü–º–ø–æ—Ä—Ç JSON<input id="import-file" type="file" accept=".json" style="display:none">
      </label>
      <button id="logout" class="btn ghost secondary">–í–∏–π—Ç–∏</button>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <h1 id="page-title">–ì–æ–ª–æ–≤–Ω–∞</h1>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="search" placeholder="–ü–æ—à—É–∫..." style="min-width:220px">
        <div id="admin-actions" class="hidden"><button id="btn-add-client" class="btn">–î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞</button></div>
        <div id="master-actions" class="hidden"><button id="btn-add-order-master" class="btn">–ù–æ–≤–∏–π –Ω–∞—Ä—è–¥</button></div>
      </div>
    </div>

    <div id="view-dashboard" class="view">
      <div class="card"><strong>–í—ñ—Ç–∞–Ω–Ω—è</strong><div class="small">–í–∏ —É–≤—ñ–π—à–ª–∏ —è–∫ <span id="role-display"></span></div></div>
      <div class="card">
        <div style="display:flex;gap:12px">
          <div><strong>–ö–ª—ñ—î–Ω—Ç—ñ–≤</strong><div id="stat-clients">0</div></div>
          <div><strong>–ù–∞—Ä—è–¥—ñ–≤</strong><div id="stat-orders">0</div></div>
          <div><strong>–î–æ—Ö–æ–¥ (30–¥)</strong><div id="stat-rev">0 ‚Ç¥</div></div>
        </div>
      </div>
      <div class="card"><strong>–û—Å—Ç–∞–Ω–Ω—ñ –∑–º—ñ–Ω–∏</strong><div id="recent-changes" class="small"></div></div>
    </div>

    <div id="view-clients" class="view hidden">
      <div class="card"><strong>–ö–ª—ñ—î–Ω—Ç–∏</strong></div>
      <div class="card">
        <table class="table" id="clients-table">
          <thead><tr><th>–Ü–º'—è</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ê–≤—Ç–æ</th><th>–ú–∞–π—Å—Ç–µ—Ä</th><th>–î—ñ—ó</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="view-orders" class="view hidden">
      <div class="card"><strong>–ù–∞—Ä—è–¥–∏</strong></div>
      <div class="card">
        <table class="table" id="orders-table"><thead><tr><th>‚Ññ</th><th>–ö–ª—ñ—î–Ω—Ç</th><th>–¢–∏–ø</th><th>–ú–∞–π—Å—Ç–µ—Ä</th><th>–°—É–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î—ñ—ó</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div id="view-stock" class="view hidden">
      <div class="card"><strong>–°–∫–ª–∞–¥</strong></div>
      <div class="card">
        <table class="table" id="stock-table"><thead><tr><th>–ù–∞–∑–≤–∞</th><th>–ö-—Ç—å</th><th>–ú—ñ–Ω</th><th>–î—ñ—ó</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div id="view-services" class="view hidden">
      <div class="card"><strong>–ü–æ—Å–ª—É–≥–∏</strong></div>
      <div class="card">
        <table class="table" id="services-table"><thead><tr><th>–ù–∞–∑–≤–∞</th><th>–¶—ñ–Ω–∞</th><th>–î—ñ—ó</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div id="view-users" class="view hidden">
      <div class="card"><strong>–ú–∞–π—Å—Ç—Ä–∏ —Ç–∞ –¥–æ—Å—Ç—É–ø–∏</strong></div>
      <div class="card">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="new-user-name" placeholder="–Ü–º'—è –º–∞–π—Å—Ç—Ä–∞">
          <input id="new-user-pin" placeholder="PIN (4 —Ü–∏—Ñ—Ä–∏)">
          <button id="add-user" class="btn">–î–æ–¥–∞—Ç–∏</button>
        </div>
        <div style="margin-top:12px"><strong>–°–ø–∏—Å–æ–∫ –º–∞–π—Å—Ç—Ä—ñ–≤</strong>
          <div id="users-list" class="assign-list"></div>
        </div>
      </div>
    </div>

    <div id="view-settings" class="view hidden">
      <div class="card"><strong>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</strong></div>
      <div class="card"><button id="btn-reset" class="btn secondary">–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –¥–µ–º–æ</button></div>
    </div>

  </main>
</div>

<!-- Login modal -->
<div id="login-modal" class="modal active"><div class="modal-content" style="max-width:420px;text-align:center">
  <h2>–í—Ö—ñ–¥ —É CRM ‚Äî –°–¢–û –§—ñ–∫—Å–∏–∫–∏</h2>
  <div style="display:flex;flex-direction:column;gap:8px;margin-top:10px">
    <select id="login-user"></select>
    <input id="login-pin" type="password" placeholder="PIN">
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="login-btn" class="btn">–£–≤—ñ–π—Ç–∏</button>
      <button id="login-demo" class="btn secondary">–î–µ–º–æ (–∞–¥–º—ñ–Ω)</button>
    </div>
  </div>
</div></div>

<!-- Modal shell -->
<div id="modal" class="modal"><div id="modal-inner" class="modal-content"></div></div>
<div id="toast" class="notification"></div>

<script>
/* PWA service worker registration */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(e=>console.warn('SW err',e));
}

/* Data model */
const LS = 'sf_data_v3_pwa';
let state = { users:[], clients:[], services:[], stock:[], orders:[], logs:[] };

/* Utils */
function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function save(){ localStorage.setItem(LS, JSON.stringify(state)); renderAll(); }
function load(){ try{ const r = localStorage.getItem(LS); if(r) state = JSON.parse(r); }catch(e){ console.error(e); } if(!state.users) seedDemo(); }
function show(msg, err=false){ const t = document.getElementById('toast'); t.textContent = msg; t.style.background = err? '#ff6b6b':'#2ecc71'; t.className = 'notification active'; setTimeout(()=> t.className='notification', 3000); }
function hashPin(pin){ return btoa(String(pin)); } // simple encoding (not secure, but sufficient locally)
function currentUser(){ return window._CURRENT_USER || null; }
function setCurrentUser(u){ window._CURRENT_USER = u; updateUserUI(); }

/* Seed */
function seedDemo(){
  state = {
    users:[
      {id:uid('u'), name:'–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä', role:'admin', pin:hashPin('1234')},
      {id:uid('u'), name:'–ú–∞–π—Å—Ç–µ—Ä 1', role:'master', pin:hashPin('1111'), assignedClientIds:[]},
      {id:uid('u'), name:'–ú–∞–π—Å—Ç–µ—Ä 2', role:'master', pin:hashPin('2222'), assignedClientIds:[]}
    ],
    clients:[
      {id:uid('c'), name:'–Ü–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤', phone:'+380971234567', car:'VW Passat', masterId:null},
      {id:uid('c'), name:'–û–ª–µ–≥ –ö–æ–≤–∞–ª—å', phone:'+380631112233', car:'Mercedes Sprinter', masterId:null}
    ],
    services:[
      {id:uid('s'), name:'–ó–∞–º—ñ–Ω–∞ –º–∞—Å–ª–∞', price:800},
      {id:uid('s'), name:'–†–µ–º–æ–Ω—Ç —Ö–æ–¥–æ–≤–æ—ó', price:900}
    ],
    stock:[
      {id:uid('p'), name:'–ú–∞—Å–ª–æ 5W-40 (1–ª)', qty:25, min:5, price:350},
      {id:uid('p'), name:'–ö–æ–ª–æ–¥–∫–∏ (–∫–æ–º–ø–ª–µ–∫—Ç)', qty:5, min:2, price:950}
    ],
    orders:[],
    logs:[]
  };
  save();
}

/* Rendering */
function renderAll(){
  renderUserList();
  renderClients();
  renderOrders();
  renderStock();
  renderServices();
  updateDashboard();
  renderUsersTab();
}
function renderUserList(){
  const sel = document.getElementById('login-user');
  sel.innerHTML = state.users.map(u=>`<option value="${u.id}">${u.name} (${u.role})</option>`).join('');
}
function updateUserUI(){
  const ui = document.getElementById('user-info');
  const user = currentUser();
  if(user){
    ui.innerHTML = `<div class="user-badge">${user.name} ‚Ä¢ ${user.role}</div>`;
    document.getElementById('admin-actions').classList.toggle('hidden', user.role !== 'admin');
    document.getElementById('master-actions').classList.toggle('hidden', user.role !== 'master');
    document.getElementById('users-tab').style.display = user.role === 'admin' ? 'block' : 'none';
  } else {
    ui.innerHTML = '';
  }
}
function renderClients(){
  const tbody = document.querySelector('#clients-table tbody');
  tbody.innerHTML = '';
  const user = currentUser();
  const list = state.clients.filter(c => {
    if(!user) return false;
    if(user.role === 'admin') return true;
    // master sees only assigned clients
    return user.assignedClientIds && user.assignedClientIds.includes(c.id);
  });
  list.forEach(c=>{
    const master = state.users.find(u=>u.id===c.masterId);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${c.name}</td><td>${c.phone}</td><td>${c.car}</td><td>${master?master.name:'‚Äî'}</td>
      <td>
        ${currentUser() && currentUser().role==='admin' ? `<button class="btn" data-action="assign" data-id="${c.id}">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏</button>` : ''}
        <button class="btn" data-action="new-order" data-id="${c.id}">–ù–∞—Ä—è–¥</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
function renderOrders(){
  const tbody = document.querySelector('#orders-table tbody'); tbody.innerHTML = '';
  const user = currentUser();
  const list = state.orders.filter(o => {
    if(!user) return false;
    if(user.role==='admin') return true;
    return o.masterId === user.id;
  });
  list.forEach(o=>{
    const client = state.clients.find(c=>c.id===o.clientId);
    const master = state.users.find(u=>u.id===o.masterId);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${o.id.substring(0,6)}</td><td>${client?client.name:'‚Äî'}</td><td>${o.type}</td><td>${master?master.name:'‚Äî'}</td><td>${(o.total||0).toFixed(2)} ‚Ç¥</td><td>${o.status}</td>
      <td>${currentUser() && currentUser().role==='master' ? `<button class="btn" data-action="take-stock" data-id="${o.id}">–í–∑—è—Ç–∏ –∑—ñ —Å–∫–ª–∞–¥—É</button>` : ''}<button class="btn" data-action="view-order" data-id="${o.id}">–í—ñ–¥–∫—Ä–∏—Ç–∏</button></td>`;
    tbody.appendChild(tr);
  });
}
function renderStock(){
  const tbody = document.querySelector('#stock-table tbody'); tbody.innerHTML='';
  state.stock.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${p.name}</td><td>${p.qty}</td><td>${p.min}</td><td>${currentUser() && currentUser().role==='admin'?`<button class="btn" data-action="edit-stock" data-id="${p.id}">–†–µ–¥.</button>`:''}</td>`;
    tbody.appendChild(tr);
  });
}
function renderServices(){ const tbody=document.querySelector('#services-table tbody'); tbody.innerHTML=''; state.services.forEach(s=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${s.name}</td><td>${s.price} ‚Ç¥</td><td>${currentUser() && currentUser().role==='admin'?`<button class="btn" data-action="edit-service" data-id="${s.id}">–†–µ–¥.</button>`:''}</td>`; tbody.appendChild(tr); }); }
function updateDashboard(){
  document.getElementById('stat-clients').textContent = state.clients.length;
  document.getElementById('stat-orders').textContent = state.orders.length;
  const rev = state.orders.filter(o=> o.created >= Date.now()-30*24*3600*1000).reduce((s,o)=>s+(o.total||0),0);
  document.getElementById('stat-rev').textContent = rev.toFixed(2) + ' ‚Ç¥';
  document.getElementById('recent-changes').textContent = state.logs.slice().slice(-5).map(l=>l.msg).reverse().join(' ‚Ä¢ ');
}

/* Users management (admin) */
function renderUsersTab(){
  const div = document.getElementById('users-list'); div.innerHTML='';
  state.users.filter(u=>u.role==='master').forEach(u=>{
    const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='6px 0';
    el.innerHTML = `<div>${u.name} (PIN: ${atob(u.pin)})</div><div><button class="btn" data-action="del-user" data-id="${u.id}">–í–∏–¥–∞–ª–∏—Ç–∏</button></div>`;
    div.appendChild(el);
  });
}

/* Actions */
document.getElementById('add-user').addEventListener('click', ()=>{
  const name = document.getElementById('new-user-name').value.trim();
  const pin = document.getElementById('new-user-pin').value.trim();
  if(!name || !pin){ show('–í–≤–µ–¥—ñ—Ç—å —ñ–º—è —Ç–∞ PIN', true); return; }
  const u = {id:uid('u'), name, role:'master', pin:hashPin(pin), assignedClientIds:[]};
  state.users.push(u); save(); show('–ú–∞–π—Å—Ç—Ä–∞ –¥–æ–¥–∞–Ω–æ');
});
document.getElementById('login-btn').addEventListener('click', ()=>{
  const uidSel = document.getElementById('login-user').value;
  const pin = document.getElementById('login-pin').value.trim();
  const user = state.users.find(u=>u.id===uidSel);
  if(!user){ show('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', true); return; }
  if(user.pin === hashPin(pin)){
    setCurrentUser(user);
    document.getElementById('login-modal').classList.remove('active');
    document.getElementById('app').style.display='flex';
    renderAll();
    show('–í—Ö—ñ–¥ —É—Å–ø—ñ—à–Ω–∏–π');
  } else show('–ù–µ–≤—ñ—Ä–Ω–∏–π PIN', true);
});
document.getElementById('login-demo').addEventListener('click', ()=>{ seedDemo(); document.getElementById('login-modal').classList.remove('active'); document.getElementById('app').style.display='flex'; setCurrentUser(state.users.find(u=>u.role==='admin')); renderAll(); });

document.getElementById('logout').addEventListener('click', ()=>{ setCurrentUser(null); document.getElementById('app').style.display='none'; document.getElementById('login-modal').classList.add('active'); });

document.getElementById('btn-add-client').addEventListener('click', ()=> openAddClient());
document.getElementById('btn-add-order-master').addEventListener('click', ()=> openOrderForm(currentUser()?.id));

document.getElementById('export-json').addEventListener('click', ()=> {
  const a = document.createElement('a'); a.href = 'data:application/json,'+encodeURIComponent(JSON.stringify(state,null,2)); a.download='fixiki_pwa.json'; a.click();
  show('–ï–∫—Å–ø–æ—Ä—Ç JSON –≥–æ—Ç–æ–≤–∏–π');
});
document.getElementById('import-file').addEventListener('change', (e)=> {
  const f = e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const imp = JSON.parse(r.result); if(imp.users) { state=imp; save(); show('–Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ'); } else show('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç', true);}catch(err){ show('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É', true);} }; r.readAsText(f);
});

/* Delegated actions */
document.body.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-action]'); if(!btn) return;
  const act = btn.dataset.action, id = btn.dataset.id;
  if(act==='assign'){ openAssignMaster(id); }
  else if(act==='new-order'){ openOrderForm(id); }
  else if(act==='view-order'){ viewOrder(id); }
  else if(act==='take-stock'){ takeStockForOrder(id); }
  else if(act==='del-user'){ state.users = state.users.filter(u=>u.id!==id); save(); show('–ú–∞–π—Å—Ç—Ä–∞ –≤–∏–¥–∞–ª–µ–Ω–æ'); }
  else if(act==='edit-stock'){ editStock(id); }
});

/* Add client (admin) */
function openAddClient(){
  const html = `<div style="display:flex;flex-direction:column;gap:8px">
    <input id="c-name" placeholder="–Ü–º'—è">
    <input id="c-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
    <input id="c-car" placeholder="–ê–≤—Ç–æ">
    <select id="c-master"><option value="">‚Äî –±–µ–∑ –º–∞–π—Å—Ç—Ä–∞ ‚Äî</option>${state.users.filter(u=>u.role==='master').map(u=>`<option value="${u.id}">${u.name}</option>`).join('')}</select>
    <div style="display:flex;gap:8px;justify-content:flex-end"><button id="save-client" class="btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button> <button data-close class="btn secondary">–í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button></div>
  </div>`;
  openModal(html);
  document.getElementById('save-client').addEventListener('click', ()=>{
    const name = document.getElementById('c-name').value.trim();
    const phone = document.getElementById('c-phone').value.trim();
    const car = document.getElementById('c-car').value.trim();
    const masterId = document.getElementById('c-master').value || null;
    if(!name || !phone){ show('–Ü–º—è —Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω –ø–æ—Ç—Ä—ñ–±–Ω—ñ', true); return; }
    const c = {id:uid('c'), name, phone, car, masterId};
    state.clients.push(c);
    // assign client id to master assignedClientIds
    if(masterId){
      const m = state.users.find(u=>u.id===masterId);
      if(m){ m.assignedClientIds = m.assignedClientIds || []; m.assignedClientIds.push(c.id); }
    }
    state.logs.push({ts:Date.now(), msg:`–î–æ–¥–∞–Ω–æ –∫–ª—ñ—î–Ω—Ç–∞ ${name}`});
    save(); closeModal(); show('–ö–ª—ñ—î–Ω—Ç–∞ –¥–æ–¥–∞–Ω–æ');
  });
}

/* Assign master to client */
function openAssignMaster(clientId){
  const html = `<div style="display:flex;flex-direction:column;gap:8px">
    <div>–û–±–µ—Ä—ñ—Ç—å –º–∞–π—Å—Ç—Ä–∞ –¥–ª—è –∫–ª—ñ—î–Ω—Ç–∞</div>
    <select id="assign-master">${state.users.filter(u=>u.role==='master').map(u=>`<option value="${u.id}">${u.name}</option>`).join('')}</select>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="save-assign" class="btn">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏</button> <button data-close class="btn secondary">–í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button></div>
  </div>`;
  openModal(html);
  document.getElementById('save-assign').addEventListener('click', ()=>{
    const masterId = document.getElementById('assign-master').value;
    const client = state.clients.find(c=>c.id===clientId);
    if(client){
      // remove from previous master's list
      if(client.masterId){
        const prev = state.users.find(u=>u.id===client.masterId);
        if(prev && prev.assignedClientIds) prev.assignedClientIds = prev.assignedClientIds.filter(x=>x!==client.id);
      }
      client.masterId = masterId;
      const m = state.users.find(u=>u.id===masterId);
      if(m){ m.assignedClientIds = m.assignedClientIds || []; if(!m.assignedClientIds.includes(client.id)) m.assignedClientIds.push(client.id); }
      state.logs.push({ts:Date.now(), msg:`–ö–ª—ñ—î–Ω—Ç—É ${client.name} –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ –º–∞–π—Å—Ç—Ä–∞`});
      save(); closeModal(); show('–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–æ');
    }
  });
}

/* Order form */
function openOrderForm(clientId=null){
  const user = currentUser();
  if(!user){ show('–ù–µ –≤—Ö—ñ–¥'); return; }
  const clientOptions = state.clients.map(c=>`<option value="${c.id}">${c.name} ${c.car?'- '+c.car:''}</option>`).join('');
  const html = `<div style="display:flex;flex-direction:column;gap:8px">
    <select id="o-client">${clientOptions}</select>
    <select id="o-type"><option value="—Ä–æ–±–æ—Ç–∞">–í–∏–∫–æ–Ω–∞–Ω—ñ —Ä–æ–±–æ—Ç–∏</option><option value="–∑–∞–ø—á–∞—Å—Ç–∏–Ω–∏">–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏</option></select>
    <div id="o-items"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end"><button id="add-o-item" class="btn">–î–æ–¥–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é</button><button id="save-order" class="btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button></div>
  </div>`;
  openModal(html);
  if(clientId) document.getElementById('o-client').value = clientId;
  document.getElementById('add-o-item').addEventListener('click', ()=> {
    const row = document.createElement('div'); row.style.display='flex'; row.style.gap='6px';
    row.innerHTML = `<input class="oi-name" placeholder="–ù–∞–∑–≤–∞"><input class="oi-qty" type="number" value="1" style="width:80px"><input class="oi-price" type="number" value="0" style="width:100px"><button class="btn ghost" onclick="this.parentElement.remove()">X</button>`;
    document.getElementById('o-items').appendChild(row);
  });
  document.getElementById('save-order').addEventListener('click', ()=>{
    const clientId = document.getElementById('o-client').value;
    const type = document.getElementById('o-type').value;
    const items = Array.from(document.querySelectorAll('#o-items .oi-name')).map((el,i)=>({
      name: el.value,
      qty: Number(document.querySelectorAll('#o-items .oi-qty')[i].value||0),
      price: Number(document.querySelectorAll('#o-items .oi-price')[i].value||0)
    })).filter(it=>it.name && it.qty>0);
    if(items.length===0){ show('–î–æ–¥–∞–π—Ç–µ –ø–æ–∑–∏—Ü—ñ—ó', true); return; }
    const total = items.reduce((s,it)=>s + it.qty*it.price,0);
    const order = {id:uid('o'), clientId, masterId: user.role==='master'?user.id:null, type: type==='–∑–∞–ø—á–∞—Å—Ç–∏–Ω–∏'?'–∑–∞–ø—á–∞—Å—Ç–∏–Ω–∏':'—Ä–æ–±–æ—Ç–∞', items, total, status:'–≤ —Ä–æ–±–æ—Ç—ñ', created:Date.now()};
    state.orders.push(order);
    state.logs.push({ts:Date.now(), msg:`–î–æ–¥–∞–Ω–æ –Ω–∞—Ä—è–¥ ${order.id}`});
    save(); closeModal(); show('–ù–∞—Ä—è–¥ —Å—Ç–≤–æ—Ä–µ–Ω–æ');
  });
}

/* View order */
function viewOrder(id){
  const o = state.orders.find(x=>x.id===id); if(!o) return;
  const client = state.clients.find(c=>c.id===o.clientId);
  const itemsHtml = o.items.map(it=>`<tr><td>${it.name}</td><td>${it.qty}</td><td>${it.price} ‚Ç¥</td><td>${(it.qty*it.price).toFixed(2)} ‚Ç¥</td></tr>`).join('');
  const html = `<h3>–ù–∞—Ä—è–¥ ${o.id}</h3><div class="small">–ö–ª—ñ—î–Ω—Ç: ${client?client.name:'‚Äî'}</div><div class="card"><table class="table"><thead><tr><th>–ù–∞–∑–≤–∞</th><th>–ö-—Ç—å</th><th>–¶—ñ–Ω–∞</th><th>–°—É–º–∞</th></tr></thead><tbody>${itemsHtml}</tbody></table></div>
    <div style="display:flex;gap:8px"><button id="mark-done" class="btn">–ü–æ–∑–Ω–∞—á–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–æ</button><button id="print-pdf" class="btn secondary">–î—Ä—É–∫ PDF</button></div>`;
  openModal(html);
  document.getElementById('mark-done').addEventListener('click', ()=>{
    o.status='–≤–∏–∫–æ–Ω–∞–Ω–æ'; state.logs.push({ts:Date.now(), msg:`–ù–∞—Ä—è–¥ ${o.id} –≤–∏–∫–æ–Ω–∞–Ω–æ`}); save(); closeModal(); show('–ù–∞—Ä—è–¥ –≤–∏–∫–æ–Ω–∞–Ω–æ');
  });
  document.getElementById('print-pdf').addEventListener('click', ()=> {
    if(window.jspdf && window.jspdf.jsPDF){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y=20; doc.setFontSize(14); doc.text('–°–¢–û –§—ñ–∫—Å–∏–∫–∏ ‚Äî –ù–∞—Ä—è–¥',14,y); y+=8;
      doc.setFontSize(11); doc.text(`–ù–∞—Ä—è–¥: ${o.id}`,14,y); y+=6; doc.text(`–ö–ª—ñ—î–Ω—Ç: ${client?client.name:''}`,14,y); y+=8;
      o.items.forEach(it=>{ doc.text(`${it.name} x${it.qty} ‚Äî ${it.price} ‚Ç¥`,14,y); y+=6; if(y>270){ doc.addPage(); y=14; } });
      y+=8; doc.text(`–†–∞–∑–æ–º: ${o.total.toFixed(2)} ‚Ç¥`,14,y);
      doc.save(`narjad_${o.id}.pdf`); show('PDF –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
    } else show('jsPDF –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ', true);
  });
}

/* Take stock for order (master) */
function takeStockForOrder(orderId){
  const o = state.orders.find(x=>x.id===orderId);
  if(!o) return;
  // show list of stock items and allow to deduct quantities
  let html = '<h3>–°–ø–∏—Å–∞—Ç–∏ –∑—ñ —Å–∫–ª–∞–¥—É</h3><div style="display:flex;flex-direction:column;gap:8px">';
  state.stock.forEach(s=>{
    html += `<div style="display:flex;gap:8px;align-items:center"><div style="flex:1">${s.name} (–∑–∞—Ä–∞–∑: ${s.qty})</div><input type="number" min="0" max="${s.qty}" value="0" id="take_${s.id}" style="width:80px"></div>`;
  });
  html += `<div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="do-take" class="btn">–°–ø–∏—Å–∞—Ç–∏</button> <button data-close class="btn secondary">–í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button></div></div>`;
  openModal(html);
  document.getElementById('do-take').addEventListener('click', ()=>{
    state.stock.forEach(s=>{
      const val = Number(document.getElementById('take_'+s.id).value||0);
      if(val>0){
        if(val > s.qty){ show(`–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ ${s.name}`, true); return; }
        s.qty -= val;
      }
    });
    state.logs.push({ts:Date.now(), msg:`–ú–∞–π—Å—Ç–µ—Ä ${currentUser().name} —Å–ø–∏—Å–∞–≤ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –¥–ª—è ${orderId}`});
    save(); closeModal(); show('–°–ø–∏—Å–∞–Ω–æ –∑—ñ —Å–∫–ª–∞–¥—É');
  });
}

/* edit stock/service (admin) */
function editStock(id){
  const p = state.stock.find(x=>x.id===id);
  const html = `<div style="display:flex;flex-direction:column;gap:8px"><input id="e-name" value="${p.name}"><input id="e-qty" type="number" value="${p.qty}"><input id="e-min" type="number" value="${p.min}"><input id="e-price" type="number" value="${p.price}"><div style="display:flex;gap:8px;justify-content:flex-end"><button id="save-stock" class="btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button><button data-close class="btn secondary">–í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button></div></div>`;
  openModal(html);
  document.getElementById('save-stock').addEventListener('click', ()=>{
    p.name = document.getElementById('e-name').value.trim();
    p.qty = Number(document.getElementById('e-qty').value||0);
    p.min = Number(document.getElementById('e-min').value||0);
    p.price = Number(document.getElementById('e-price').value||0);
    save(); closeModal(); show('–û–Ω–æ–≤–ª–µ–Ω–æ');
  });
}
function editService(id){
  const s = state.services.find(x=>x.id===id);
  const html = `<div style="display:flex;flex-direction:column;gap:8px"><input id="s-name" value="${s.name}"><input id="s-price" type="number" value="${s.price}"><div style="display:flex;gap:8px;justify-content:flex-end"><button id="save-s" class="btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button><button data-close class="btn secondary">–í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button></div></div>`;
  openModal(html);
  document.getElementById('save-s').addEventListener('click', ()=>{ s.name = document.getElementById('s-name').value.trim(); s.price = Number(document.getElementById('s-price').value||0); save(); closeModal(); show('–û–Ω–æ–≤–ª–µ–Ω–æ'); });
}

/* Modal helpers */
function openModal(html){ document.getElementById('modal').classList.add('active'); document.getElementById('modal-inner').innerHTML = html; const closeBtn = document.querySelector('[data-close]'); if(closeBtn) closeBtn.addEventListener('click', closeModal); }
function closeModal(){ document.getElementById('modal').classList.remove('active'); document.getElementById('modal-inner').innerHTML=''; }

/* Assign via button in clients table */
function assignClientToMaster(clientId, masterId){
  const client = state.clients.find(c=>c.id===clientId);
  if(!client) return;
  // remove from previous master list
  if(client.masterId){
    const prev = state.users.find(u=>u.id===client.masterId);
    if(prev && prev.assignedClientIds) prev.assignedClientIds = prev.assignedClientIds.filter(x=>x!==client.id);
  }
  client.masterId = masterId;
  const m = state.users.find(u=>u.id===masterId);
  if(m){ m.assignedClientIds = m.assignedClientIds || []; if(!m.assignedClientIds.includes(client.id)) m.assignedClientIds.push(client.id); }
  state.logs.push({ts:Date.now(), msg:`–ö–ª—ñ—î–Ω—Ç—É ${client.name} –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ –º–∞–π—Å—Ç—Ä–∞ ${m.name}`});
  save(); show('–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–æ –º–∞–π—Å—Ç—Ä–∞');
}

/* Open assign modal */
function openAssignMaster(clientId){
  openAssignMaster; // placeholder
}

/* Delegation for menu */
document.querySelectorAll('.menu button').forEach(b=> b.addEventListener('click', ()=>{
  document.querySelectorAll('.menu button').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  const view = b.dataset.view;
  document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden'));
  document.getElementById('view-'+view).classList.remove('hidden');
  document.getElementById('page-title').textContent = b.textContent;
}));

/* storage event to sync across tabs */
window.addEventListener('storage', (e)=>{ if(e.key===LS) load(); });

/* initial load */
load();
renderAll();

/* expose some functions to global for inline handlers */
window.openOrderForm = openOrderForm;
window.viewOrder = viewOrder;

/* Keyboard shortcut: ctrl+shift+d to reset demo */
document.addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.shiftKey && e.key==='D'){ seedDemo(); show('Demo reset'); } });

/* start login UI */
renderUserList();
document.getElementById('login-btn').addEventListener('click', ()=> {
  const uid = document.getElementById('login-user').value;
  const pin = document.getElementById('login-pin').value.trim();
  const user = state.users.find(u=>u.id===uid);
  if(user && user.pin === hashPin(pin)){ setCurrentUser(user); document.getElementById('login-modal').classList.remove('active'); document.getElementById('app').style.display='flex'; renderAll(); show('–í—Ö—ñ–¥ —É—Å–ø—ñ—à–Ω–∏–π'); }
  else show('–ù–µ–≤—ñ—Ä–Ω–∏–π –ª–æ–≥—ñ–Ω/PIN', true);
});

/* show users in login select */
renderUserList();

</script>
</body>
</html>
