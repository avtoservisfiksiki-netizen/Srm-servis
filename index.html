<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–°–¢–û –§—ñ–∫—Å–∏–∫–∏ ‚Äî CRM v2</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#081216; --panel:#0f1a1f; --muted:#9fb0bf; --accent:#00bcd4;
  --card:#071014; --glass: rgba(255,255,255,0.02);
  --success:#2ecc71; --danger:#ff6b6b; --warn:#f39c12;
  --maxw:1200px;
}
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#041018);color:#eaf6fb}
.container{max-width:var(--maxw);margin:18px auto;padding:12px}
.app{display:flex;gap:14px}
.sidebar{
  width:260px;background:linear-gradient(180deg,var(--panel),#091317);border-radius:12px;padding:14px;flex-shrink:0;
  display:flex;flex-direction:column;height:calc(100vh - 80px);position:sticky;top:18px;
  transition:width .2s ease;
}
.sidebar.collapsed{width:76px}
.brand{font-weight:800;font-size:18px;text-align:center;margin-bottom:8px}
.user-bubble{background:var(--card);padding:8px;border-radius:10px;text-align:center;margin-bottom:12px}
.menu{display:flex;flex-direction:column;gap:8px}
.menu button{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;border:0;background:transparent;color:var(--muted);cursor:pointer;text-align:left}
.menu button.active{background:linear-gradient(90deg, rgba(0,188,212,0.08), rgba(0,188,212,0.03));color:var(--accent);font-weight:600}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
.search{flex:1;display:flex;gap:8px;align-items:center}
.search input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
.top-actions{display:flex;gap:8px;align-items:center}
.btn{padding:8px 12px;border-radius:10px;border:0;background:var(--accent);color:#042;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.main{flex:1;min-height:70vh}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.4);margin-bottom:12px}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media(max-width:900px){ .grid{grid-template-columns:repeat(1,1fr)} .sidebar{display:none} .container{padding:8px} }
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
.kpi{display:flex;gap:10px}
.kpi .k{flex:1;padding:12px;border-radius:10px;background:var(--card);text-align:center}
.small{color:var(--muted);font-size:13px}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.tag{padding:6px 10px;border-radius:999px;background:var(--glass);font-size:13px;color:var(--muted)}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:1200}
.modal.active{display:flex}
.modal .panel{background:linear-gradient(180deg,var(--panel),#081217);padding:16px;border-radius:12px;width:95%;max-width:900px}
.form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.input,select,textarea{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;width:100%}
.header-row{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px}
.footer-note{font-size:13px;color:var(--muted);text-align:center;margin-top:8px}
.collapser{display:flex;gap:8px;align-items:center;justify-content:center;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);cursor:pointer}

</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div style="display:flex;gap:12px;align-items:center">
      <div id="sidebar-toggle" class="collapser">‚ò∞</div>
      <div class="brand">–°–¢–û –§—ñ–∫—Å–∏–∫–∏ ‚Ä¢ CRM v2</div>
      <div class="small" id="welcome">–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ</div>
    </div>
    <div class="search">
      <input id="global-search" placeholder="–ü–æ—à—É–∫: –∫–ª—ñ—î–Ω—Ç, –∞–≤—Ç–æ, –Ω–∞—Ä—è–¥..." />
      <div class="top-actions">
        <button id="backup-btn" class="btn ghost">–†–µ–∑–µ—Ä–≤–Ω–∞ –∫–æ–ø—ñ—è (ZIP)</button>
        <button id="export-json" class="btn ghost">–ï–∫—Å–ø–æ—Ä—Ç JSON</button>
        <button id="import-json" class="btn ghost">–Ü–º–ø–æ—Ä—Ç</button>
        <button id="btn-logout" class="btn ghost" style="display:none">–í–∏–π—Ç–∏</button>
      </div>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="user-bubble">
        <div id="user-name" style="font-weight:700">–ì—ñ—Å—Ç—å</div>
        <div class="small" id="user-role">–†–æ–ª—å: ‚Äî</div>
      </div>

      <nav class="menu" role="navigation">
        <button class="active" data-view="dashboard">üè† –ì–æ–ª–æ–≤–Ω–∞</button>
        <button data-view="clients">üë• –ö–ª—ñ—î–Ω—Ç–∏</button>
        <button data-view="orders">üîß –ù–∞—Ä—è–¥–∏</button>
        <button data-view="stock">üì¶ –°–∫–ª–∞–¥</button>
        <button data-view="analytics">üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞</button>
        <button data-view="settings">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
      </nav>

      <div style="margin-top:auto">
        <div class="small" style="text-align:center;margin-bottom:8px">–í–µ—Ä—Å—ñ—è: v2 ‚Ä¢ –õ–æ–∫–∞–ª—å–Ω–æ</div>
        <div style="display:flex;gap:8px;justify-content:center">
          <div id="collapse-hint" class="collapser">‚áÑ</div>
        </div>
      </div>
    </aside>

    <main class="main">
      <div id="view-dashboard" class="view">
        <div class="card header-row">
          <div>
            <h3 style="margin:0">–û–≥–ª—è–¥</h3>
            <div class="small">–®–≤–∏–¥–∫–∏–π –æ–≥–ª—è–¥ –∫–ª—é—á–æ–≤–∏—Ö –ø–æ–∫–∞–∑–Ω–∏–∫—ñ–≤</div>
          </div>
          <div class="chips" id="overview-chips"></div>
        </div>

        <div class="grid">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <strong>–ö–ª—é—á–æ–≤—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏</strong>
              <div class="small" id="last-updated">‚Äî</div>
            </div>
            <div class="kpi" style="margin-top:10px">
              <div class="k"><div class="small">–ö–ª—ñ—î–Ω—Ç—ñ–≤</div><div id="k-clients" style="font-size:20px;font-weight:700">0</div></div>
              <div class="k"><div class="small">–ê–∫—Ç–∏–≤–Ω—ñ –Ω–∞—Ä—è–¥–∏</div><div id="k-open" style="font-size:20px;font-weight:700">0</div></div>
              <div class="k"><div class="small">–ù–∞ —Å–∫–ª–∞–¥—ñ (–ø–æ–∑–∏—Ü—ñ–π)</div><div id="k-stock" style="font-size:20px;font-weight:700">0</div></div>
            </div>
          </div>

          <div class="card">
            <strong>–û—Å—Ç–∞–Ω–Ω—ñ –Ω–∞—Ä—è–¥–∏</strong>
            <table class="table" id="recent-table"><thead><tr><th>‚Ññ</th><th>–ö–ª—ñ—î–Ω—Ç</th><th>–°—É–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody></tbody></table>
          </div>

          <div class="card">
            <strong>–ù–∏–∑—å–∫–∏–π –∑–∞–ø–∞—Å</strong>
            <div id="low-stock" class="small" style="margin-top:8px">‚Äî</div>
          </div>
        </div>
      </div>

      <div id="view-clients" class="view" style="display:none">
        <div class="card header-row">
          <div><strong>–ö–ª—ñ—î–Ω—Ç–∏</strong><div class="small">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –±–∞–∑–æ—é –∫–ª—ñ—î–Ω—Ç—ñ–≤</div></div>
          <div><button id="btn-new-client" class="btn">–î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞</button></div>
        </div>
        <div class="card">
          <table class="table" id="clients-table">
            <thead><tr><th>–Ü–º'—è</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ê–≤—Ç–æ</th><th>–ó–∞–ø–∏—Å—ñ–≤</th><th>–ú–∞–π—Å—Ç–µ—Ä</th><th>–î—ñ—ó</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="view-orders" class="view" style="display:none">
        <div class="card header-row">
          <div><strong>–ù–∞—Ä—è–¥–∏</strong><div class="small">–°—Ç–≤–æ—Ä—é–π—Ç–µ —Ç–∞ –∫–µ—Ä—É–π—Ç–µ –Ω–∞—Ä—è–¥–∞–º–∏</div></div>
          <div><button id="btn-new-order" class="btn">–ù–æ–≤–∏–π –Ω–∞—Ä—è–¥</button></div>
        </div>
        <div class="card">
          <table class="table" id="orders-table"><thead><tr><th>‚Ññ</th><th>–ö–ª—ñ—î–Ω—Ç</th><th>–¢–∏–ø</th><th>–°—É–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î—ñ—ó</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div id="view-stock" class="view" style="display:none">
        <div class="card header-row">
          <div><strong>–°–∫–ª–∞–¥</strong><div class="small">–¢–æ–≤–∞—Ä–∏, –∑–∞–ª–∏—à–∫–∏, —Ä—É—Ö</div></div>
          <div><button id="btn-new-stock" class="btn">–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä</button></div>
        </div>
        <div class="card">
          <table class="table" id="stock-table"><thead><tr><th>–ù–∞–∑–≤–∞</th><th>–ö-—Ç—å</th><th>–ú—ñ–Ω.</th><th>–¶—ñ–Ω–∞</th><th>–î—ñ—ó</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div id="view-analytics" class="view" style="display:none">
        <div class="card"><strong>–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞</strong><div class="small">–ü—Ä–æ—Å—Ç—ñ –∑–≤—ñ—Ç–∏</div></div>
        <div class="card">
          <div id="analytics-content" class="small">–ì—Ä–∞—Ñ—ñ–∫–∏ —Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥—É—Ç—å —Ç—É—Ç</div>
        </div>
      </div>

      <div id="view-settings" class="view" style="display:none">
        <div class="card"><strong>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</strong>
          <div style="margin-top:8px" class="small">–°–∫–∏–Ω—É—Ç–∏ –¥–µ–º–æ-–¥–∞–Ω—ñ –∞–±–æ –µ–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –±–∞–∑—É</div>
          <div style="margin-top:10px"><button id="btn-reset" class="btn ghost">–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –¥–µ–º–æ-–¥–∞–Ω—ñ</button></div>
        </div>
      </div>

    </main>
  </div>

  <div class="footer-note">¬© –°–¢–û –§—ñ–∫—Å–∏–∫–∏ ‚Äî CRM v2</div>
</div>

<!-- Modal -->
<div id="modal" class="modal"><div class="panel" id="modal-inner"></div></div>

<script>
/* ====== App state ====== */
const LS = 'fixiki_crm_v2';
let state = {
  users: [], clients: [], stock: [], services: [], orders: [], logs: []
};
let currentUser = null;

/* ====== Utils ====== */
function uid(pref='id'){ return pref+'_'+Date.now().toString(36)+Math.random().toString(36).slice(2,6); }
function save(){ localStorage.setItem(LS, JSON.stringify(state)); renderAll(); }
function load(){ const s = localStorage.getItem(LS); if(s){ try{ state = JSON.parse(s); }catch(e){ console.error(e);} } if(!state.users || state.users.length===0) seedDemo(); }
function showToast(msg, ok=true){ const el = document.createElement('div'); el.textContent = msg; el.style.position='fixed'; el.style.right='18px'; el.style.bottom='18px'; el.style.padding='8px 12px'; el.style.background = ok? 'var(--success)' : 'var(--danger)'; el.style.color='#042'; el.style.borderRadius='8px'; document.body.appendChild(el); setTimeout(()=>el.remove(),2600); }
function fmt(n){ return (Number(n)||0).toFixed(2) + ' ‚Ç¥'; }
function escape(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ====== Demo seed ====== */
function seedDemo(){
  state = {
    users: [{id:uid('u'), login:'admin', role:'admin', pin:'1234'}, {id:uid('u'), login:'master1', role:'master', pin:'1111'}],
    clients: [{id:uid('c'), name:'–Ü–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤', phone:'+380971234567', car:'VW Passat', history:[]},{id:uid('c'), name:'–û–ª–µ–Ω–∞ –Ü–≤–∞–Ω–æ–≤–∞', phone:'+380501112233', car:'Toyota Corolla', history:[]}],
    stock: [{id:uid('p'), name:'–ú–∞—Å–ª–æ 5W-40 (1–ª)', qty:25, min:5, price:350, desc:'–ú–æ—Ç–æ—Ä–Ω–µ –º–∞—Å–ª–æ'},{id:uid('p'), name:'–§—ñ–ª—å—Ç—Ä –º–∞—Å–ª—è–Ω–∏–π', qty:10, min:2, price:120, desc:'OEM'}],
    services: [{id:uid('s'), name:'–ó–∞–º—ñ–Ω–∞ –º–∞—Å–ª–∞', price:800},{id:uid('s'), name:'–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞', price:600}],
    orders: [],
    logs: []
  };
  save();
}

/* ====== Auth (simple for demo) ====== */
function promptLogin(){
  const login = prompt('–õ–æ–≥—ñ–Ω: (admin/master1)','admin');
  if(!login) return;
  const user = state.users.find(u=>u.login===login);
  if(!user){ alert('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'); return; }
  const pin = prompt('PIN:','1234');
  if(pin !== user.pin){ alert('–ù–µ–≤—ñ—Ä–Ω–∏–π PIN'); return; }
  currentUser = user;
  document.getElementById('user-name').textContent = currentUser.login;
  document.getElementById('user-role').textContent = '–†–æ–ª—å: ' + currentUser.role;
  document.getElementById('btn-logout').style.display = 'inline-block';
  document.getElementById('welcome').textContent = '–í–∏ —É–≤—ñ–π—à–ª–∏ —è–∫ ' + currentUser.login;
  renderAll();
}

/* ====== Render functions ====== */
function renderAll(){
  renderDashboard();
  renderClients();
  renderOrders();
  renderStock();
  renderAnalytics();
  renderOverview();
}
function renderOverview(){
  document.getElementById('overview-chips').innerHTML = `<div class="tag">–ö–ª—ñ—î–Ω—Ç—ñ–≤: ${state.clients.length}</div><div class="tag">–ù–∞—Ä—è–¥—ñ–≤: ${state.orders.length}</div><div class="tag">–ü–æ–∑–∏—Ü—ñ–π: ${state.stock.length}</div>`;
}
function renderDashboard(){
  document.getElementById('k-clients').textContent = state.clients.length;
  const open = state.orders.filter(o=> o.status !== '–≤–∏–∫–æ–Ω–∞–Ω–æ' && o.status !== '—Å–∫–∞—Å–æ–≤–∞–Ω–æ').length;
  document.getElementById('k-open').textContent = open;
  document.getElementById('k-stock').textContent = state.stock.length;
  const tbody = document.querySelector('#recent-table tbody'); tbody.innerHTML = '';
  state.orders.slice().reverse().slice(0,6).forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${o.id.substring(0,6)}</td><td>${escape(o.clientName)}</td><td>${fmt(o.total)}</td><td>${escape(o.status)}</td>`;
    tbody.appendChild(tr);
  });
  const low = state.stock.filter(p=>p.qty < p.min);
  document.getElementById('low-stock').innerHTML = low.length ? low.map(p=>`${escape(p.name)} (${p.qty}/${p.min})`).join('<br>') : '‚Äî';
  document.getElementById('last-updated').textContent = state.orders.length ? new Date(Math.max(...state.orders.map(o=>o.created))).toLocaleString() : '‚Äî';
}
function renderClients(){
  const tbody = document.querySelector('#clients-table tbody'); tbody.innerHTML = '';
  state.clients.forEach(c=>{
    const tr = document.createElement('tr');
    const master = state.users.find(u=>u.id===c.masterId);
    tr.innerHTML = `<td>${escape(c.name)}</td><td>${escape(c.phone)}</td><td>${escape(c.car||'')}</td><td>${(c.history||[]).length}</td><td>${master?escape(master.login):'‚Äî'}</td>
      <td><button class="btn" data-action="view-client" data-id="${c.id}">–í—ñ–¥–∫—Ä–∏—Ç–∏</button> <button class="btn ghost" data-action="edit-client" data-id="${c.id}">–†–µ–¥.</button></td>`;
    tbody.appendChild(tr);
  });
}
function renderOrders(){
  const tbody = document.querySelector('#orders-table tbody'); tbody.innerHTML = '';
  state.orders.slice().reverse().forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${o.id.substring(0,6)}</td><td>${escape(o.clientName)}</td><td>${escape(o.type)}</td><td>${fmt(o.total)}</td><td>${escape(o.status)}</td>
      <td><button class="btn" data-action="view-order" data-id="${o.id}">–í—ñ–¥–∫—Ä–∏—Ç–∏</button></td>`;
    tbody.appendChild(tr);
  });
}
function renderStock(){
  const tbody = document.querySelector('#stock-table tbody'); tbody.innerHTML = '';
  state.stock.forEach(p=>{
    const low = p.qty < p.min;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escape(p.name)}</td><td>${p.qty} ${low?'<span class="small" style="color:var(--danger)">(–Ω–∏–∑—å–∫–∏–π)</span>':''}</td><td>${p.min}</td><td>${fmt(p.price)}</td><td><button class="btn ghost" data-action="edit-stock" data-id="${p.id}">–†–µ–¥.</button> <button class="btn" data-action="take-stock" data-id="${p.id}">–°–ø–∏—Å–∞—Ç–∏</button></td>`;
    tbody.appendChild(tr);
  });
}
function renderAnalytics(){
  document.getElementById('analytics-content').textContent = '–ù–∞–π–ø–æ–ø—É–ª—è—Ä–Ω—ñ—à—ñ –ø–æ—Å–ª—É–≥–∏: ' + (state.services.map(s=>s.name).join(', ') || '‚Äî');
}

/* ====== Actions ====== */
document.querySelectorAll('.menu button').forEach(b=> b.addEventListener('click', ()=>{
  document.querySelectorAll('.menu button').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  const view = b.dataset.view;
  document.querySelectorAll('.view').forEach(v=>v.style.display='none');
  document.getElementById('view-'+view).style.display='block';
}));

document.getElementById('sidebar-toggle').addEventListener('click', ()=> promptLogin());

document.getElementById('btn-new-client').addEventListener('click', ()=> openClientModal());
document.getElementById('btn-new-order').addEventListener('click', ()=> openOrderModal());
document.getElementById('btn-new-stock').addEventListener('click', ()=> openStockModal());

document.body.addEventListener('click', (e)=>{
  const t = e.target.closest('[data-action]');
  if(!t) return;
  const act = t.dataset.action, id = t.dataset.id;
  if(act==='view-client') viewClient(id);
  if(act==='edit-client') editClient(id);
  if(act==='view-order') viewOrder(id);
  if(act==='edit-stock') openStockModal(id);
  if(act==='take-stock') openTakeStock(id);
});

/* ====== Modals ====== */
const modal = document.getElementById('modal');
function openModal(html){ modal.classList.add('active'); document.getElementById('modal-inner').innerHTML = html; document.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click', closeModal)); }
function closeModal(){ modal.classList.remove('active'); document.getElementById('modal-inner').innerHTML=''; }

/* ====== Client Modal ====== */
function openClientModal(clientId=null){
  const c = clientId ? state.clients.find(x=>x.id===clientId) : {};
  const html = `<h3>${clientId?'–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞':'–î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞'}</h3>
    <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
      <input id="c-name" class="input" placeholder="–Ü–º'—è" value="${escape(c.name||'')}">
      <input id="c-phone" class="input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" value="${escape(c.phone||'')}">
      <input id="c-car" class="input" placeholder="–ê–≤—Ç–æ" value="${escape(c.car||'')}">
      <div style="display:flex;justify-content:flex-end;gap:8px"><button id="save-client" class="btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button><button data-close class="btn ghost">–í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button></div>
    </div>`;
  openModal(html);
  document.getElementById('save-client').addEventListener('click', ()=>{
    const name = document.getElementById('c-name').value.trim(); const phone = document.getElementById('c-phone').value.trim(); const car = document.getElementById('c-car').value.trim();
    if(!name || !phone){ alert('–Ü–º—è —Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω –ø–æ—Ç—Ä—ñ–±–Ω—ñ'); return; }
    if(clientId){ Object.assign(c,{name,phone,car}); state.logs.push({ts:Date.now(), msg:`–ö–ª—ñ—î–Ω—Ç –æ–Ω–æ–≤–ª–µ–Ω–∏–π: ${name}`}); }
    else{ state.clients.push({id:uid('c'), name, phone, car, history:[]}); state.logs.push({ts:Date.now(), msg:`–î–æ–¥–∞–Ω–æ –∫–ª—ñ—î–Ω—Ç–∞: ${name}`}); }
    save(); closeModal(); showToast('–ö–ª—ñ—î–Ω—Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
  });
}
function editClient(id){ openClientModal(id); }
function viewClient(id){
  const c = state.clients.find(x=>x.id===id); if(!c) return;
  const hist = (c.history||[]).slice().reverse().map(h=>`<tr><td>${new Date(h.date).toLocaleString()}</td><td>${escape(h.desc)}</td><td>${fmt(h.cost)}</td></tr>`).join('');
  const html = `<h3>${escape(c.name)}</h3><div class="small">–¢–µ–ª: ${escape(c.phone)} ‚Ä¢ –ê–≤—Ç–æ: ${escape(c.car||'')}</div>
    <div class="card" style="margin-top:8px"><strong>–Ü—Å—Ç–æ—Ä—ñ—è</strong><table class="table"><thead><tr><th>–î–∞—Ç–∞</th><th>–û–ø–∏—Å</th><th>–í–∞—Ä—Ç—ñ—Å—Ç—å</th></tr></thead><tbody>${hist}</tbody></table>
    <div style="margin-top:8px"><button id="add-history" class="btn">–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å</button></div></div>
    <div style="display:flex;justify-content:flex-end;gap:8px"><button data-close class="btn ghost">–ó–∞–∫—Ä–∏—Ç–∏</button></div>`;
  openModal(html);
  document.getElementById('add-history').addEventListener('click', ()=>{
    const hHtml = `<h3>–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å</h3><div style="display:flex;flex-direction:column;gap:8px"><input id="h-desc" class="input" placeholder="–û–ø–∏—Å"><input id="h-cost" class="input" placeholder="–í–∞—Ä—Ç—ñ—Å—Ç—å"><div style="display:flex;justify-content:flex-end;gap:8px"><button id="save-h" class="btn">–î–æ–¥–∞—Ç–∏</button><button data-close class="btn ghost">–í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button></div></div>`;
    openModal(hHtml);
    document.getElementById('save-h').addEventListener('click', ()=>{
      const desc = document.getElementById('h-desc').value.trim(); const cost = Number(document.getElementById('h-cost').value||0);
      if(!desc) { alert('–û–ø–∏—Å –ø–æ—Ç—Ä—ñ–±–µ–Ω'); return; }
      c.history = c.history || []; c.history.push({date:Date.now(), desc, cost}); state.logs.push({ts:Date.now(), msg:`–î–æ–¥–∞–Ω–æ –≤ —ñ—Å—Ç–æ—Ä—ñ—é ${c.name}: ${desc}`}); save(); closeModal(); showToast('–ó–∞–ø–∏—Å –¥–æ–¥–∞–Ω–æ');
    });
  });
}

/* ====== Orders ====== */
function openOrderModal(){
  const html = `<h3>–ù–æ–≤–∏–π –Ω–∞—Ä—è–¥</h3><div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
    <label>–ö–ª—ñ—î–Ω—Ç</label><select id="o-client" class="input">${state.clients.map(c=>`<optio...
