<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–¢–û –§—ñ–∫—Å–∏–∫–∏ ‚Äî CRM (–ü–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–∞ –í–µ—Ä—Å—ñ—è)</title>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#06080a;
      --panel:#0e1518;
      --muted:#94a3b8;
      --accent:#2f9cff;
      --card:#0b1114;
      --glass: rgba(255,255,255,0.03);
      --success:#2ecc71;
      --danger:#ff6b6b;
      --warning:#f39c12;
    }
    *{box-sizing:border-box;font-family:Inter, Roboto, Arial, sans-serif}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#041018);color:#e6eef5;min-height:100vh}
    .app{display:flex;min-height:100vh}
    .sidebar{width:260px;background:linear-gradient(180deg,var(--panel),#081011);padding:18px;display:flex;flex-direction:column;gap:14px;position:sticky;top:0;height:100vh;flex-shrink:0}
    .brand{font-weight:800;font-size:20px;text-align:center}
    .menu button{display:flex;align-items:center;gap:12px;width:100%;padding:10px;border-radius:10px;border:0;background:transparent;color:var(--muted);cursor:pointer;transition:all 0.15s ease}
    .menu button.active{background:linear-gradient(90deg,rgba(47,156,255,0.12),rgba(47,156,255,0.06));color:var(--accent);font-weight:600}
    .menu button:hover{background:rgba(255,255,255,0.02);color:#fff}
    .main{flex:1;padding:20px;overflow:auto}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:8px;flex-wrap:wrap}
    h1{margin:0;font-size:24px;font-weight:700}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:12px}
    .stat{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.45);text-align:center;border-left:4px solid var(--accent);transition:transform 0.2s ease}
    .stat:hover{transform:translateY(-2px)}
    .stat .label{color:var(--muted);font-size:13px}
    .stat .value{font-size:24px;font-weight:800;margin-top:6px;color:var(--accent)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:16px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.2)}
    .row{display:flex;gap:12px;align-items:center}
    .btn{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#061017;cursor:pointer;font-weight:600;transition:background 0.2s ease}
    .btn:hover{background:#4fa8ff}
    .btn.secondary{background:var(--panel);border:1px solid rgba(255,255,255,0.06);color:var(--muted);transition:background 0.2s ease, color 0.2s ease}
    .btn.secondary:hover{background:rgba(255,255,255,0.05);color:#fff}
    .btn.ghost{background:transparent;color:var(--muted);border-radius:8px;padding:8px 10px;border:1px solid transparent}
    .btn.ghost:hover{border-color:rgba(255,255,255,0.1);color:#fff}
    .btn.danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:0.6;cursor:not-allowed}
    .table{width:100%;border-collapse:collapse;margin-top:12px}
    .table th, .table td{padding:12px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:14px}
    .table th{font-weight:700;color:#fff}
    .table tbody tr:hover{background:rgba(255,255,255,0.015)}
    input, textarea, select{background:var(--card);border:1px solid rgba(255,255,255,0.06);color:inherit;padding:10px 12px;border-radius:8px;outline:none;transition:border-color 0.2s ease}
    input:focus, textarea:focus, select:focus{border-color:var(--accent)}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
    .actions{display:flex;gap:8px;align-items:center}
    .floating{position:fixed;right:22px;bottom:22px;z-index:40}
    .muted{color:var(--muted)}
    .chip{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:999px;font-size:13px;color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}
    .tag-paid{color:var(--success);font-weight:700}
    .tag-unpaid{color:var(--danger);font-weight:700}
    .tag-low-stock{background:rgba(243, 156, 18, 0.2);color:var(--warning);padding:3px 8px;border-radius:4px;font-weight:600}
    .flex-col{display:flex;flex-direction:column;gap:10px}
    .modal-content{max-width:1000px;width:100%;background:var(--panel);padding:20px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.5);overflow-y:auto;max-height:90vh}
    .notification{position:fixed;bottom:20px;right:20px;background:var(--success);color:#fff;padding:10px 15px;border-radius:8px;z-index:2000;opacity:0;transition:opacity 0.3s ease}
    .notification.error{background:var(--danger)}
    .notification.active{opacity:1}
    .order-item-row input, .order-item-row select { height: 40px; padding: 5px 8px; }
    
    @media (max-width:1024px) {
        .modal-content { max-width: 95vw; }
    }
    @media (max-width:900px){ .sidebar{display:none} .main{padding:12px} .header{flex-direction:column;align-items:stretch} .row{flex-wrap:wrap} }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar" role="navigation" aria-label="–ú–µ–Ω—é">
      <div style="flex:1">
        <div class="brand">–°–¢–û –§—ñ–∫—Å–∏–∫–∏</div>
        <div class="small muted" style="text-align:center;margin-top:6px">CRM ‚Ä¢ –ü–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–∞ v1.0</div>

        <nav class="menu" style="margin-top:20px">
          <button class="active" data-view="dashboard">üè† –ì–æ–ª–æ–≤–Ω–∞</button>
          <button data-view="clients">üë• –ö–ª—ñ—î–Ω—Ç–∏</button>
          <button data-view="orders">üìã –ù–∞—Ä—è–¥–∏</button>
          <button data-view="services">üîß –ü–æ—Å–ª—É–≥–∏</button>
          <button data-view="stock">üì¶ –°–∫–ª–∞–¥</button>
          <button data-view="payments">üí≥ –û–ø–ª–∞—Ç–∏</button>
          <button data-view="settings">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
        </nav>
      </div>

      <div style="display:flex;flex-direction:column;gap:10px">
        <div class="small muted">–î–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ</div>
        <div style="display:flex;gap:6px">
          <button id="export-json" class="btn ghost" title="–ï–∫—Å–ø–æ—Ä—Ç —É JSON">JSON</button>
          <button id="export-xlsx" class="btn ghost" title="–ï–∫—Å–ø–æ—Ä—Ç —É XLSX">XLSX</button>
        </div>
        <div style="display:flex;gap:6px">
          <label class="ghost" style="cursor:pointer;padding:6px 8px;border-radius:8px;border:1px dashed rgba(255,255,255,0.04);text-align:center;flex:1">
            –Ü–º–ø–æ—Ä—Ç JSON
            <input id="import-file" type="file" accept=".json" style="display:none">
          </label>
          <button id="clear-all" class="btn ghost secondary" title="–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –ª–æ–∫–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>
        <div class="small muted" style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.05);padding-top:8px">–†–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤: 4 ‚Ä¢ 20 –∫–ª./–º—ñ—Å</div>
      </div>
    </aside>

    <main class="main">
      <div class="header">
        <h1 id="page-title">–ì–æ–ª–æ–≤–Ω–∞</h1>
        <div class="row">
          <input id="search" placeholder="–ü–æ—à—É–∫: –∫–ª—ñ—î–Ω—Ç, –∞–≤—Ç–æ, —Ç–µ–ª–µ—Ñ–æ–Ω..." style="min-width:250px" />
          <div class="actions">
            <button id="btn-add-client" class="btn">–î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞</button>
            <button id="btn-add-order" class="btn secondary">–ù–æ–≤–∏–π –Ω–∞—Ä—è–¥</button>
          </div>
        </div>
      </div>

      <div id="content">
        <div id="view-dashboard" class="view">
          <div class="stats">
            <div class="stat card">
              <div class="label">–ê–≤—Ç–æ –≤ —Ä–æ–±–æ—Ç—ñ</div>
              <div class="value" id="stat-inwork">0</div>
            </div>
            <div class="stat card">
              <div class="label">–ö–ª—ñ—î–Ω—Ç—ñ–≤ —É –±–∞–∑—ñ</div>
              <div class="value" id="stat-clients">0</div>
            </div>
            <div class="stat card">
              <div class="label">–ù–µ–≤–∏–∫–æ–Ω–∞–Ω—ñ –Ω–∞—Ä—è–¥–∏</div>
              <div class="value" id="stat-open-orders">0</div>
            </div>
          </div>

          <div id="low-stock-alert" class="card" style="display:none;margin-bottom:12px;border-left:4px solid var(--warning)">
            <strong style="color:var(--warning)">‚ö†Ô∏è –£–≤–∞–≥–∞! –ù–∏–∑—å–∫–∏–π –∑–∞–ø–∞—Å —Ç–æ–≤–∞—Ä—ñ–≤!</strong>
            <div class="small muted" id="low-stock-list"></div>
          </div>

          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <strong>–û—Å—Ç–∞–Ω–Ω—ñ –Ω–∞—Ä—è–¥–∏</strong>
              <div class="small muted" id="last-updated">‚Äî</div>
            </div>
            <table class="table" id="recent-orders">
              <thead><tr><th>‚Ññ</th><th>–ö–ª—ñ—î–Ω—Ç</th><th>–ê–≤—Ç–æ</th><th>–°—É–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="view-clients" class="view" style="display:none">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div><strong>–ö–ª—ñ—î–Ω—Ç–∏</strong><div class="small muted">–°–ø–∏—Å–æ–∫ –∫–ª—ñ—î–Ω—Ç—ñ–≤ —Ç–∞ –∞–≤—Ç–æ</div></div>
              <div class="small muted">–ó–Ω–∞–π–¥–µ–Ω–æ: <span id="clients-count">0</span></div>
            </div>

            <table class="table" id="clients-table">
              <thead><tr><th>–Ü–º'—è</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ê–≤—Ç–æ</th><th>–ù–æ—Ç–∞—Ç–∫–∏</th><th>–î—ñ—ó</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="view-orders" class="view" style="display:none">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div><strong>–ù–∞—Ä—è–¥–∏</strong><div class="small muted">–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –Ω–∞—Ä—è–¥–∞–º–∏</div></div>
              <div class="small muted">–í—Å—å–æ–≥–æ: <span id="orders-count">0</span></div>
            </div>

            <table class="table" id="orders-table">
              <thead><tr><th>‚Ññ</th><th>–ö–ª—ñ—î–Ω—Ç</th><th>–ê–≤—Ç–æ</th><th>–ü–æ—Å–ª—É–≥–∏/–¥–µ—Ç–∞–ª—ñ</th><th>–°—É–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î—ñ—ó</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="view-services" class="view" style="display:none">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div><strong>–ü–æ—Å–ª—É–≥–∏</strong><div class="small muted">–°–ª–æ–≤–Ω–∏–∫ –ø–æ—Å–ª—É–≥ —ñ —Ü—ñ–Ω–∏</div></div>
              <div class="actions">
                <button id="btn-add-service" class="btn">–î–æ–¥–∞—Ç–∏ –ø–æ—Å–ª—É–≥—É</button>
              </div>
            </div>

            <table class="table" id="services-table">
              <thead><tr><th>–ù–∞–∑–≤–∞</th><th>–¶—ñ–Ω–∞</th><th>–î—ñ—ó</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="view-stock" class="view" style="display:none">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div><strong>–°–∫–ª–∞–¥</strong><div class="small muted">–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏ —Ç–∞ —Ä–æ–∑—Ö—ñ–¥–Ω–∏–∫–∏</div></div>
              <div class="actions">
                <button id="btn-add-stock" class="btn">–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä</button>
              </div>
            </div>

            <table class="table" id="stock-table">
              <thead><tr><th>–ù–∞–∑–≤–∞</th><th>–ö—ñ–ª-—Ç—å</th><th>–ú—ñ–Ω—ñ–º—É–º</th><th>–¶—ñ–Ω–∞</th><th>–î—ñ—ó</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="view-payments" class="view" style="display:none">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div><strong>–û–ø–ª–∞—Ç–∏</strong><div class="small muted">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç –ø–æ –Ω–∞—Ä—è–¥–∞—Ö</div></div>
              <div class="small muted">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ: <span id="unpaid-count">0</span></div>
            </div>

            <table class="table" id="payments-table">
              <thead><tr><th>–ù–∞—Ä—è–¥</th><th>–ö–ª—ñ—î–Ω—Ç</th><th>–°—É–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="view-settings" class="view" style="display:none">
          <div class="card">
            <strong>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</strong>
            <div class="small muted" style="margin-top:8px">–õ–æ–∫–∞–ª—å–Ω–µ —Å—Ö–æ–≤–∏—â–µ: <span id="ls-key">sf_data_v1</span></div>
            <div style="margin-top:12px" class="flex-col">
              <button id="btn-reset-demo" class="btn secondary">–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –¥–µ–º–æ-–¥–∞–Ω—ñ</button>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;padding:20px;z-index:1000">
    <div id="modal-inner" class="modal-content">
      </div>
  </div>

  <div id="notification" class="notification"></div>

<script>
/* ---------- App data & localStorage ---------- */
const LS_KEY = 'sf_data_v1';
let state = {
  clients: [],      // {id,name,phone,car,note,created}
  services: [],     // {id,name,price}
  stock: [],        // {id,name,qty,min,price}
  orders: [],       // {id,clientId,car,items:[{type:'service'|'stock',id,qty,price, name, spended:bool}], total, status, created, paid, spended:bool}
};

/* ---------- Utilities ---------- */
function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + Math.floor(Math.random()*1000).toString(36); }
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); renderAll(); }
function loadState(){ 
  try{ 
    const r = localStorage.getItem(LS_KEY); 
    if(r) state = JSON.parse(r); 
    if (state.clients.length === 0 && state.services.length === 0) {
        seedDemo();
    }
    // –ó–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –ø–æ–ª—è spended –¥–ª—è —Å—Ç–∞—Ä–∏—Ö –Ω–∞—Ä—è–¥—ñ–≤
    state.orders.forEach(o => {
        if (o.spended === undefined) o.spended = false;
        o.items.forEach(it => { if (it.spended === undefined) it.spended = false; });
    });
  }catch(e){ 
    console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É:", e);
    seedDemo();
  } 
  renderAll();
}
function formatPrice(n){ return (Number(n)||0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, " ") + ' ‚Ç¥'; }
function findClient(id){ return state.clients.find(c=>c.id===id) || null; }
function findService(id){ return state.services.find(s=>s.id===id) || null; }
function findStock(id){ return state.stock.find(s=>s.id===id) || null; }
function findOrder(id){ return state.orders.find(o=>o.id===id) || null; }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]}); }

function showNotification(message, isError = false){
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = 'notification ' + (isError ? 'error' : 'active');
    setTimeout(() => {
        notification.className = 'notification';
    }, 3000);
}

const ORDER_STATUSES = ['–Ω–æ–≤–∏–π', '–≤ —Ä–æ–±–æ—Ç—ñ', '–æ—á—ñ–∫—É—î –∑–∞–ø—á–∞—Å—Ç–∏–Ω', '–≥–æ—Ç–æ–≤–æ', '–≤–∏–∫–æ–Ω–∞–Ω–æ', '—Å–∫–∞—Å–æ–≤–∞–Ω–æ'];

/* ---------- Initial demo data helper ---------- */
function seedDemo(){
  state = {
    clients: [
      {id:uid('c'), name:'–Ü–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤', phone:'+380971234567', car:'VW Passat (AA1234BB)', note:'–†–µ–≥—É–ª—è—Ä–Ω–∏–π –∫–ª—ñ—î–Ω—Ç. –ó–∞–≤–∂–¥–∏ –±–µ—Ä–µ 5W-40', created:Date.now()},
      {id:uid('c'), name:'–û–ª–µ–≥ –ö–æ–≤–∞–ª—å', phone:'+380631112233', car:'Mercedes Sprinter (CA5678II)', note:'–î–æ—Å—Ç–∞–≤–∫–∞, —Ç–µ—Ä–º—ñ–Ω–æ–≤—ñ —Ä–µ–º–æ–Ω—Ç–∏', created:Date.now() - 86400000},
      {id:uid('c'), name:'–ú–∞—Ä—ñ—è –°–∏–¥–æ—Ä–µ–Ω–∫–æ', phone:'+380509876543', car:'Mazda 3', note:'–¢—ñ–ª—å–∫–∏ –ø–ª–∞–Ω–æ–≤—ñ –¢–û', created:Date.now() - 2 * 86400000},
    ],
    services: [
      {id:uid('s'), name:'–ó–∞–º—ñ–Ω–∞ –º–∞—Å–ª–∞', price:800},
      {id:uid('s'), name:'–†–µ–º–æ–Ω—Ç —Ö–æ–¥–æ–≤–æ—ó (–Ω–æ—Ä–º–æ-–≥–æ–¥–∏–Ω–∞)', price:900},
      {id:uid('s'), name:'–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –µ–ª–µ–∫—Ç—Ä–∏–∫–∏', price:600},
    ],
    stock: [
      {id:uid('p'), name:'–§—ñ–ª—å—Ç—Ä –º–∞—Å–ª—è–Ω–∏–π 124', qty:10, min:2, price:120},
      {id:uid('p'), name:'–ú–∞—Å–ª–æ 5W-40 (1–ª)', qty:25, min:10, price:350},
      {id:uid('p'), name:'–ö–æ–ª–æ–¥–∫–∏ –≥–∞–ª—å–º—ñ–≤–Ω—ñ (–∫–æ–º–ø–ª–µ–∫—Ç)', qty:1, min:3, price:950}, // –ù–∏–∑—å–∫–∏–π –∑–∞–ø–∞—Å
    ],
    orders: [],
  };
  
  const clientIvan = state.clients[0];
  const serviceOil = state.services[0];
  const stockFilter = state.stock[0];
  const stockPads = state.stock[2];

  state.orders = [
    {
        id: uid('o'), 
        clientId: clientIvan.id, 
        car:'VW Passat (AA1234BB)', 
        items:[
            {type:'service', id:serviceOil.id, qty:1, price:serviceOil.price, name:serviceOil.name, spended:false},
            {type:'stock', id:stockFilter.id, qty:1, price:stockFilter.price, name:stockFilter.name, spended:true}
        ], 
        total: serviceOil.price + stockFilter.price, 
        status:'–≤–∏–∫–æ–Ω–∞–Ω–æ', 
        created:Date.now() - 86400000, 
        paid:true,
        spended: true // –ü–æ–∑–Ω–∞—á–∞—î–º–æ, —â–æ –∑–∞–ø–∞—Å–∏ –≤–∂–µ —Å–ø–∏—Å–∞–Ω—ñ
    },
    {
        id: uid('o'), 
        clientId: state.clients[1].id, 
        car:'Mercedes Sprinter', 
        items:[
            {type:'service', id:state.services[1].id, qty:4, price:state.services[1].price, name:state.services[1].name, spended:false},
            {type:'stock', id:stockPads.id, qty:2, price:stockPads.price, name:stockPads.name, spended:false}
        ], 
        total: (4 * state.services[1].price) + (2 * stockPads.price), 
        status:'–≤ —Ä–æ–±–æ—Ç—ñ', 
        created:Date.now(), 
        paid:false,
        spended: false
    },
  ];

  saveState();
}

/* ---------- Rendering ---------- */
const menuBtns = document.querySelectorAll('.menu button');
const views = document.querySelectorAll('.view');
const pageTitle = document.getElementById('page-title');
const searchInput = document.getElementById('search');

function switchView(view){
  menuBtns.forEach(b=>b.classList.toggle('active', b.dataset.view===view));
  views.forEach(v=>v.style.display = v.id === 'view-' + view ? 'block' : 'none');
  pageTitle.textContent = {
    'dashboard':'–ì–æ–ª–æ–≤–Ω–∞',
    'clients':'–ö–ª—ñ—î–Ω—Ç–∏',
    'orders':'–ù–∞—Ä—è–¥–∏',
    'services':'–ü–æ—Å–ª—É–≥–∏',
    'stock':'–°–∫–ª–∞–¥',
    'payments':'–û–ø–ª–∞—Ç–∏',
    'settings':'–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è'
  }[view] || '–°–¢–û –§—ñ–∫—Å–∏–∫–∏';
  
  const renderMap = {
    'clients': renderClients,
    'orders': renderOrders,
    'services': renderServices,
    'stock': renderStock,
    'payments': renderPayments,
    'dashboard': renderDashboard
  };
  if(renderMap[view]) renderMap[view]();
  searchInput.value = '';
}

menuBtns.forEach(b=> b.addEventListener('click', ()=> switchView(b.dataset.view)));

/* Render all */
function renderAll(){
  renderDashboard();
  renderClients();
  renderOrders();
  renderServices();
  renderStock();
  renderPayments();
}

/* Dashboard */
function renderDashboard(){
  document.getElementById('stat-clients').textContent = state.clients.length;
  const open = state.orders.filter(o=>o.status !== '–≤–∏–∫–æ–Ω–∞–Ω–æ' && o.status !== '—Å–∫–∞—Å–æ–≤–∞–Ω–æ').length;
  document.getElementById('stat-open-orders').textContent = open;
  document.getElementById('stat-inwork').textContent = state.orders.filter(o=>o.status==='–≤ —Ä–æ–±–æ—Ç—ñ').length;
  
  // Alert for low stock
  const lowStock = state.stock.filter(p => p.qty < p.min);
  const lowStockAlert = document.getElementById('low-stock-alert');
  if (lowStock.length > 0) {
    lowStockAlert.style.display = 'block';
    document.getElementById('low-stock-list').innerHTML = lowStock.map(p => `‚Ä¢ ${escapeHtml(p.name)} (${p.qty} / ${p.min})`).join('<br>');
  } else {
    lowStockAlert.style.display = 'none';
  }

  // recent orders
  const tbody = document.querySelector('#recent-orders tbody');
  tbody.innerHTML = '';
  state.orders.slice().sort((a,b)=>b.created - a.created).slice(0, 6).forEach(o=>{
    const tr = document.createElement('tr');
    const client = findClient(o.clientId);
    tr.innerHTML = `<td>${o.id.substring(0,6)}...</td><td>${client?escapeHtml(client.name):'‚Äî'}</td><td>${escapeHtml(o.car||'‚Äî')}</td><td>${formatPrice(o.total)}</td><td>${o.status}</td>`;
    tbody.appendChild(tr);
  });
  const lastOrderTime = state
